import{d as ae,I as le,r as x,J as oe,c as i,a as l,f as s,w as o,b as m,e as L,h as b,F as re,k as ue,B as M,C as ne,M as N,x as r,y as u,j as c,z as w}from"./index-Dwc_z1ot.js";import{k as ie,l as de}from"./use-dataset-BTECfA9z.js";import{u as pe}from"./helper-QRapnIPA.js";const _e={class:"p-6"},ce={class:"flex items-center mb-6 gap-4"},me={class:"w-[520px] mx-auto"},ve={class:"min-h-[calc(100vh-160px)] p-[48px]"},fe={key:0,class:""},ye={key:1,class:""},ge={key:0,class:""},xe={key:2,class:""},be={class:"flex flex-col gap-2"},ke={class:"flex items-center gap-2.5"},Ce={class:""},we={class:"text-gray-700"},he={class:"text-gray-500"},De={key:0,class:"text-gray-500"},ze={key:1,class:""},Ue={key:2,class:""},qe={key:3,class:"text-gray-500"},Fe={class:"flex items-center justify-between px-[48px]"},Se={class:"flex items-center gap-2"},Ve={key:2,class:"flex items-center gap-2"},Ne=ae({__name:"CreateView",setup(Te){let v=0,h="",D=0;const f=ne(),{loading:z,create_documents_result:$,handleCreateDocuments:j}=ie(),{upload_file:E,handleUploadFile:O}=le(),{documents_status_result:U,loadDocumentsStatus:X}=de(),d=x(1),t=x({file_list:[],process_type:"automatic",rule:{separators:["\\n"],chunk_size:500,chunk_overlap:50,pre_process_rules:[]}}),q=x(),F=x([]),G=async()=>{var y,e;if(d.value===1){if(t.value.file_list.length===0){N.error("请上传需要添加到知识库的文件");return}if(!t.value.file_list.every(n=>{var _;return(_=n.response)==null?void 0:_.id})){N.warning("文件正在上传中，请稍等");return}d.value++}else{if(t.value.process_type==="custom"&&await((y=q.value)==null?void 0:y.validate()))return;try{const p={upload_file_ids:t.value.file_list.map(n=>{var _;return(_=n==null?void 0:n.response)==null?void 0:_.id}),process_type:t.value.process_type};t.value.process_type==="custom"&&(p.rule={pre_process_rules:[{id:"remove_extra_space",enabled:t.value.rule.pre_process_rules.includes("remove_extra_space")},{id:"remove_url_and_email",enabled:t.value.rule.pre_process_rules.includes("remove_url_and_email")}],segment:{separators:t.value.rule.separators.map(n=>pe(n)),chunk_size:t.value.rule.chunk_size,chunk_overlap:t.value.rule.chunk_overlap}}),await j(String((e=f.params)==null?void 0:e.dataset_id),p),h=$.value.batch,await S(),J(),d.value++}finally{z.value=!1}}},S=async()=>{var e;D++,await X(String((e=f.params)==null?void 0:e.dataset_id),h),F.value=U.value,D>=30&&k(),U.value.every(p=>p.status==="completed"||p.status==="error")&&k()},J=()=>v=setInterval(S,5e3),k=()=>{v&&(clearInterval(v),v=0)};return oe(()=>k()),(y,e)=>{var B,R;const p=r("icon-left"),n=r("a-button"),_=r("router-link"),C=r("a-step"),P=r("a-steps"),A=r("a-upload"),H=r("a-divider"),I=r("a-input-tag"),g=r("a-form-item"),V=r("a-input-number"),T=r("a-checkbox"),K=r("a-checkbox-group"),Q=r("a-form"),W=r("icon-file"),Y=r("a-avatar");return u(),i("div",_e,[l("div",ce,[s(_,{to:{name:"space-datasets-documents-list",params:{dataset_id:(B=m(f).params)==null?void 0:B.dataset_id}}},{default:o(()=>[s(n,{size:"mini",type:"text",class:"!text-gray-700"},{icon:o(()=>[s(p)]),_:1})]),_:1},8,["to"]),e[8]||(e[8]=l("div",{class:"text-lg font-bold text-gray-700"},"添加文件",-1))]),l("div",me,[s(P,{current:d.value},{default:o(()=>[s(C,null,{default:o(()=>e[9]||(e[9]=[c("上传")])),_:1}),s(C,null,{default:o(()=>e[10]||(e[10]=[c("分段设置")])),_:1}),s(C,null,{default:o(()=>e[11]||(e[11]=[c("数据处理")])),_:1})]),_:1},8,["current"])]),l("div",ve,[d.value===1?(u(),i("div",fe,[s(A,{"file-list":t.value.file_list,"onUpdate:fileList":e[0]||(e[0]=a=>t.value.file_list=a),draggable:"",accept:".doc,.docx,.pdf,.txt,.md,.markdown",limit:10,multiple:"",tip:"支持PDF、TXT、DOC、DOCX、MD，最多可上传10个文件，每个文件的大小不超过10MB","custom-request":a=>{const{fileItem:Z,onSuccess:ee,onError:te}=a;return(async()=>{try{await m(O)(Z.file),ee(m(E))}catch(se){te(se)}})(),{abort:()=>{}}}},null,8,["file-list","custom-request"])])):d.value===2?(u(),i("div",ye,[l("div",{class:L(`px-5 py-4 bg-white rounded-lg border cursor-pointer mb-4 hover:border-blue-700 ${t.value.process_type==="automatic"?"border-blue-700":""}`),onClick:e[1]||(e[1]=a=>t.value.process_type="automatic")},e[12]||(e[12]=[l("div",{class:"font-bold text-gray-700 mb-2"},"自动分段与清洗",-1),l("div",{class:"text-gray-500"},"自动分段与预处理规则",-1)]),2),l("div",{class:L(`px-5 py-4 bg-white rounded-lg border cursor-pointer hover:border-blue-700 ${t.value.process_type==="custom"?"border-blue-700":""}`),onClick:e[6]||(e[6]=a=>t.value.process_type="custom")},[e[15]||(e[15]=l("div",{class:"font-bold text-gray-700 mb-2"},"自定义",-1)),e[16]||(e[16]=l("div",{class:"text-gray-500"},"自定义分段规则、分段长度与预处理规则",-1)),t.value.process_type==="custom"?(u(),i("div",ge,[s(H),s(Q,{model:t.value.rule,ref_key:"customRuleFormRef",ref:q,layout:"vertical"},{default:o(()=>[s(g,{field:"separators",label:"分段标识符",required:"","asterisk-position":"end",rules:[{required:!0,message:"分段标识符不能为空"}]},{default:o(()=>[s(I,{"model-value":t.value.rule.separators,"onUpdate:modelValue":e[2]||(e[2]=a=>t.value.rule.separators=a),placeholder:"请输入分段标识符，按下Enter结束"},null,8,["model-value"])]),_:1}),s(g,{field:"chunk_size",label:"分段最大长度",required:"","asterisk-position":"end",rules:[{required:!0,message:"分段最大长度不能为空"}]},{default:o(()=>[s(V,{"model-value":t.value.rule.chunk_size,"onUpdate:modelValue":e[3]||(e[3]=a=>t.value.rule.chunk_size=a),min:100,max:1e3,step:1,"default-value":500,placeholder:"请输入100-1000的数字"},null,8,["model-value"])]),_:1}),s(g,{field:"chunk_overlap",label:"块重叠数",required:"","asterisk-position":"end",rules:[{required:!0,message:"块重叠大小不能为空"}]},{default:o(()=>[s(V,{"model-value":t.value.rule.chunk_overlap,"onUpdate:modelValue":e[4]||(e[4]=a=>t.value.rule.chunk_overlap=a),min:0,max:500,step:1,"default-value":50,placeholder:"请输入0-500的数字"},null,8,["model-value"])]),_:1}),s(g,{field:"pre_process_rules",label:"文本预处理规则"},{default:o(()=>[s(K,{"model-value":t.value.rule.pre_process_rules,"onUpdate:modelValue":e[5]||(e[5]=a=>t.value.rule.pre_process_rules=a),direction:"vertical"},{default:o(()=>[s(T,{value:"remove_extra_space"},{default:o(()=>e[13]||(e[13]=[c(" 替换掉连续的空格、换行符和制表符 ")])),_:1}),s(T,{value:"remove_url_and_email"},{default:o(()=>e[14]||(e[14]=[c("删除所有 URL 和电子邮件")])),_:1})]),_:1},8,["model-value"])]),_:1})]),_:1},8,["model"])])):b("",!0)],2)])):(u(),i("div",xe,[e[17]||(e[17]=l("div",{class:"text-gray-900 mb-4 text-base"},"服务器正在处理中",-1)),l("div",be,[(u(!0),i(re,null,ue(F.value,a=>(u(),i("div",{key:a.id,class:"flex items-center justify-between px-4 py-3 bg-white rounded-lg border"},[l("div",ke,[s(Y,{shape:"square",class:"bg-blue-700",size:32},{default:o(()=>[s(W)]),_:1}),l("div",Ce,[l("div",we,w(a.name),1),l("div",he,w((a.size/1024).toFixed(2))+"kb",1)])]),a.segment_count===0?(u(),i("div",De,"0.00%")):a.status==="error"?(u(),i("div",ze,"处理出错")):a.status==="completed"?(u(),i("div",Ue,"处理完成")):(u(),i("div",qe,w((a.completed_segment_count/a.segment_count*100).toFixed(2))+"% ",1))]))),128))])]))]),l("div",Fe,[e[22]||(e[22]=l("div",{class:""},null,-1)),l("div",Se,[d.value===2?(u(),M(n,{key:0,class:"rounded-lg",onClick:e[7]||(e[7]=()=>{d.value>1&&d.value--})},{default:o(()=>e[18]||(e[18]=[c(" 上一步 ")])),_:1})):b("",!0),d.value<=2?(u(),M(n,{key:1,loading:m(z),type:"primary",class:"rounded-lg",onClick:G},{default:o(()=>e[19]||(e[19]=[c(" 下一步 ")])),_:1},8,["loading"])):b("",!0),d.value===3?(u(),i("div",Ve,[e[21]||(e[21]=l("div",{class:"text-gray-500"},"点击确认不影响数据处理，处理完毕后可进行引用",-1)),s(_,{to:{name:"space-datasets-documents-list",params:{dataset_id:(R=m(f).params)==null?void 0:R.dataset_id}}},{default:o(()=>[s(n,{type:"primary",class:"rounded-lg"},{default:o(()=>e[20]||(e[20]=[c("确定")])),_:1})]),_:1},8,["to"])])):b("",!0)])])])}}});export{Ne as default};
