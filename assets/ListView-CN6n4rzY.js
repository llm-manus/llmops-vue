import{d as te,r as U,A as ae,B as Y,w as t,x as a,y as _,a as n,f as e,j as g,b as l,c as f,z as y,F as le,k as oe,h as ne,M as ie,G as de,o as re,C as ce,D as ue}from"./index-Ndv9oC7V.js";import{h as se}from"./moment-C5S46NFB.js";import{d as _e,e as me,f as pe,g as ge,u as ve,h as fe,i as ye,j as be}from"./use-dataset-33Ce315t.js";const xe={class:"flex items-center justify-between"},he={class:"pt-6"},we={class:"flex items-center justify-between"},ke=te({__name:"UpdateDocumentNameModal",props:{visible:{type:Boolean,required:!0},dataset_id:{type:String,required:!0},document_id:{type:String,required:!0},onAfterUpdate:{type:Function,required:!1,default:()=>({})}},emits:["update:visible"],setup(B,{emit:d}){const v=B,F=d,{document:w,loadDocument:z}=_e(),{loading:r,handleUpdateDocumentName:k}=me(),u=U({name:""}),V=U(),x=()=>{var b;F("update:visible",!1),(b=V.value)==null||b.resetFields()},D=async({errors:b})=>{b||(await k(v.dataset_id,v.document_id,u.value.name),x(),v.onAfterUpdate())};return ae(()=>v.visible,async b=>{var m;b&&(await z(v.dataset_id,v.document_id),(m=V.value)==null||m.resetFields(),u.value.name=w.value.name)}),(b,m)=>{const M=a("icon-close"),p=a("a-button"),i=a("a-input"),C=a("a-form-item"),j=a("a-space"),N=a("a-form"),o=a("a-modal");return _(),Y(o,{width:520,visible:B.visible,"hide-title":"",footer:!1,"modal-class":"rounded-xl",onCancel:x},{default:t(()=>[n("div",xe,[m[1]||(m[1]=n("div",{class:"text-lg font-bold text-gray-700"},"重命名",-1)),e(p,{type:"text",class:"!text-gray-700",size:"small",onClick:x},{icon:t(()=>[e(M)]),_:1})]),n("div",he,[e(N,{ref_key:"formRef",ref:V,model:u.value,onSubmit:D,layout:"vertical"},{default:t(()=>[e(C,{field:"name",label:"名称","asterisk-position":"end",rules:[{required:!0,message:"文档名称不能为空"}]},{default:t(()=>[e(i,{modelValue:u.value.name,"onUpdate:modelValue":m[0]||(m[0]=S=>u.value.name=S),placeholder:"请输入文档名称","show-word-limit":"","max-length":100},null,8,["modelValue"])]),_:1}),n("div",we,[m[4]||(m[4]=n("div",{class:""},null,-1)),e(j,{size:16},{default:t(()=>[e(p,{class:"rounded-lg",onClick:x},{default:t(()=>m[2]||(m[2]=[g("取消")])),_:1}),e(p,{loading:l(r),type:"primary","html-type":"submit",class:"rounded-lg"},{default:t(()=>m[3]||(m[3]=[g(" 保存 ")])),_:1},8,["loading"])]),_:1})])]),_:1},8,["model"])])]),_:1},8,["visible"])}}}),qe={class:""},ze={class:"flex items-center justify-between"},De={class:"pt-6"},Ce={class:"w-full flex justify-between gap-2"},Se={class:"flex flex-col w-1/2"},$e={class:"border border-blue-700 bg-blue-100 rounded-lg flex flex-col mb-6"},Ue={class:"flex items-center justify-between px-4 py-1.5"},Ve={key:0,class:""},Me={key:1,class:""},je={key:2,class:""},Ne={class:"bg-white rounded-lg p-2"},Re={class:"flex items-center justify-between"},Fe={class:""},He={class:"line-clamp-1"},Ye={class:""},Be={class:"w-1/2"},Te={class:"p-4 bg-gray-50 rounded-lg cursor-pointer"},Ge={key:0,class:"flex items-center gap-2 mb-1.5"},Le={class:"text-gray-700 text-xs"},Ae={class:"text-gray-500 line-clamp-4 h-[88px] break-all"},Ee={class:"flex items-center gap-2 text-gray-500 text-xs"},Pe={class:"line-clamp-1"},Qe={class:"flex items-center justify-between"},Ie={class:"flex items-center gap-4 w-full pl-3"},We={class:"flex items-center gap-4 w-full pl-3"},Je={class:"flex items-center justify-between"},Ke=te({__name:"HitTestingModal",props:{visible:{type:Boolean,required:!0},dataset_id:{type:String,required:!0}},emits:["update:visible"],setup(B,{emit:d}){const v=B,F=d,w=U(!1),z={retrieval_strategy:"semantic",k:5,score:.5},r=U(z),k=U([]),u=U({query:"",...z}),{loading:V,queries:x,loadDatasetQueries:D}=pe(),{loading:b,hits:m,handleHit:M}=ge(),p=()=>{r.value=u.value,w.value=!1},i=()=>{k.value=[],u.value={query:u.value.query,...r.value},w.value=!1},C=()=>F("update:visible",!1),j=async()=>{if(u.value.query.trim()===""){ie.error("检索源文本不能为空");return}await M(v.dataset_id,u.value),k.value=m.value,await D(v.dataset_id)};return ae(()=>v.visible,async N=>{N?await D(v.dataset_id):(x.value=[],k.value=[],u.value={query:"",...z},r.value=z)}),(N,o)=>{const S=a("icon-close"),q=a("a-button"),O=a("icon-language"),T=a("a-textarea"),$=a("a-tag"),G=a("a-table-column"),A=a("a-table"),E=a("a-divider"),X=a("icon-pushpin"),P=a("a-progress"),Z=a("icon-file"),ee=a("a-col"),Q=a("a-row"),I=a("a-empty"),W=a("a-spin"),L=a("a-modal"),J=a("a-radio-group"),s=a("a-form-item"),h=a("a-slider"),R=a("a-input-number"),H=a("a-space"),K=a("a-form");return _(),f("div",qe,[e(L,{width:1e3,visible:v.visible,"hide-title":"",footer:!1,"modal-class":"rounded-xl h-3/4 overflow-auto scrollbar-w-none",onCancel:C},{default:t(()=>[n("div",ze,[o[8]||(o[8]=n("div",{class:"text-lg font-bold text-gray-700"},"召回测试",-1)),e(q,{type:"text",class:"!text-gray-700",size:"small",onClick:C},{icon:t(()=>[e(S)]),_:1})]),o[12]||(o[12]=n("div",{class:"text-gray-500"},"基于给定的查询文本测试知识库的召回效果",-1)),n("div",De,[n("div",Ce,[n("div",Se,[n("div",$e,[n("div",Ue,[o[9]||(o[9]=n("div",{class:"font-bold text-gray-900"},"源文本",-1)),e(q,{size:"small",class:"rounded-lg px-2",onClick:o[0]||(o[0]=c=>w.value=!0)},{icon:t(()=>[e(O)]),default:t(()=>[u.value.retrieval_strategy==="semantic"?(_(),f("div",Ve," 相似性检索 ")):u.value.retrieval_strategy==="full_text"?(_(),f("div",Me," 全文检索 ")):(_(),f("div",je,"混合检索"))]),_:1})]),n("div",Ne,[e(T,{"model-value":u.value.query,"onUpdate:modelValue":o[1]||(o[1]=c=>u.value.query=c),placeholder:"请输入文本，建议使用简短的陈述句","max-length":200,"auto-size":{minRows:6,maxRows:6},class:"!bg-white !border-0 mb-1"},null,8,["model-value"]),n("div",Re,[e($,{size:"small",class:"rounded text-gray-700"},{default:t(()=>[g(y(u.value.query.length)+"/200 ",1)]),_:1}),e(q,{loading:l(b),type:"primary",size:"small",class:"rounded-lg",onClick:j},{default:t(()=>o[10]||(o[10]=[g(" 召回测试 ")])),_:1},8,["loading"])])])]),n("div",Fe,[o[11]||(o[11]=n("div",{class:"text-gray-700 font-bold mb-4"},"最近查询",-1)),e(A,{loading:l(V),pagination:!1,size:"small",bordered:{wrapper:!1},data:l(x),onRowClick:o[2]||(o[2]=c=>u.value.query=c.query)},{columns:t(()=>[e(G,{title:"数据源","data-index":"source","header-cell-class":"text-gray-500 bg-transparent border-b font-bold","cell-class":"text-gray-500",width:110}),e(G,{title:"文本","data-index":"query","header-cell-class":"text-gray-500 bg-transparent border-b font-bold","cell-class":"text-gray-500"},{cell:t(({record:c})=>[n("div",He,y(c.query),1)]),_:1}),e(G,{title:"时间","data-index":"created_at","header-cell-class":"text-gray-500 bg-transparent border-b font-bold","cell-class":"text-gray-500",width:160},{cell:t(({record:c})=>[n("div",Ye,y(l(se)(c.created_at*1e3).format("YYYY-MM-DD HH:mm")),1)]),_:1})]),_:1},8,["loading","data"])])]),e(E,{direction:"vertical"}),n("div",Be,[e(W,{loading:l(b),class:"w-full"},{default:t(()=>[k.value.length>0?(_(),Y(Q,{key:0,gutter:[16,16]},{default:t(()=>[(_(!0),f(le,null,oe(k.value,c=>(_(),Y(ee,{key:c.id,span:12},{default:t(()=>[n("div",Te,[u.value.retrieval_strategy==="semantic"?(_(),f("div",Ge,[e(X),e(P,{"stroke-width":6,"show-text":!1,percent:c.score},null,8,["percent"]),n("div",Le,y(c.score.toFixed(2)),1)])):ne("",!0),n("div",Ae,y(c.content),1),e(E,{class:"my-2"}),n("div",Ee,[e(Z,{class:"flex-shrink-0"}),n("div",Pe,y(c.document.name),1)])])]),_:2},1024))),128))]),_:1})):(_(),Y(I,{key:1}))]),_:1},8,["loading"])])])])]),_:1},8,["visible"]),e(L,{visible:w.value,"hide-title":"",footer:!1,"modal-class":"rounded-xl"},{default:t(()=>[n("div",Qe,[o[13]||(o[13]=n("div",{class:"text-lg font-bold text-gray-700"},"检索设置",-1)),e(q,{type:"text",class:"!text-gray-700",size:"small",onClick:p},{icon:t(()=>[e(S)]),_:1})]),e(K,{model:r.value,onSubmit:i,class:"pt-6"},{default:t(()=>[e(s,{field:"retrieval_strategy",label:"检索策略","label-align":"left"},{default:t(()=>[e(J,{"model-value":r.value.retrieval_strategy,"onUpdate:modelValue":o[3]||(o[3]=c=>r.value.retrieval_strategy=c),"default-value":"semantic",options:[{label:"混合策略",value:"hybrid"},{label:"全文检索",value:"full_text"},{label:"相似性检索",value:"semantic"}]},null,8,["model-value"])]),_:1}),e(s,{field:"k",label:"最大召回数量"},{default:t(()=>[n("div",Ie,[e(h,{"model-value":r.value.k,"onUpdate:modelValue":o[4]||(o[4]=c=>r.value.k=c),step:1,min:1,max:10},null,8,["model-value"]),e(R,{"model-value":r.value.k,"onUpdate:modelValue":o[5]||(o[5]=c=>r.value.k=c),class:"w-[80px]","default-value":4},null,8,["model-value"])])]),_:1}),e(s,{field:"score",label:"最小匹配度"},{default:t(()=>[n("div",We,[e(h,{"model-value":r.value.score,"onUpdate:modelValue":o[6]||(o[6]=c=>r.value.score=c),step:.01,min:0,max:.99},null,8,["model-value"]),e(R,{"model-value":r.value.score,"onUpdate:modelValue":o[7]||(o[7]=c=>r.value.score=c),class:"w-[80px]",min:0,max:.99,step:.01,precision:2,"default-value":.5},null,8,["model-value"])])]),_:1}),n("div",Je,[o[16]||(o[16]=n("div",{class:""},null,-1)),e(H,{size:16},{default:t(()=>[e(q,{class:"rounded-lg",onClick:p},{default:t(()=>o[14]||(o[14]=[g("取消")])),_:1}),e(q,{type:"primary","html-type":"submit",class:"rounded-lg"},{default:t(()=>o[15]||(o[15]=[g("保存")])),_:1})]),_:1})])]),_:1},8,["model"])]),_:1},8,["visible"])])}}}),Oe={class:"p-6"},Xe={class:"flex items-center w-full gap-2 mb-6"},Ze={class:"flex items-center gap-3"},et={class:"flex flex-col justify-between h-[40px]"},tt={key:1,class:"text-gray-700"},at={key:2,class:"flex items-center gap-2"},st={key:3,class:"flex items-center gap-2"},lt={class:"flex items-center justify-between mb-6"},ot={class:""},nt={key:0,class:"w-2 h-2 bg-green-500 rounded-sm border border-green-700"},it={key:1,class:"w-2 h-2 bg-gray-500 rounded-sm border border-gray-700"},dt={key:2,class:"text-gray-700"},rt={key:3,class:"text-gray-700"},mt=te({__name:"ListView",setup(B){const d=ce(),v=ue(),F=U(!1),w=U(!1),z=U(""),{dataset:r,loadDataset:k}=ve(),{loading:u,documents:V,paginator:x,loadDocuments:D}=fe(),{handleDelete:b}=ye(),{handleUpdate:m}=be(),M=de(()=>{var p,i,C;return{current_page:Number(((p=d.query)==null?void 0:p.current_page)??1),page_size:Number(((i=d.query)==null?void 0:i.page_size)??20),search_word:String(((C=d.query)==null?void 0:C.search_word)??"")}});return ae(()=>d.query,()=>{var p;console.log(11),D(String((p=d.params)==null?void 0:p.dataset_id),M.value)}),re(()=>{var p,i;k(String((p=d.params)==null?void 0:p.dataset_id)),D(String((i=d.params)==null?void 0:i.dataset_id),M.value)}),(p,i)=>{var Q,I,W,L,J;const C=a("icon-left"),j=a("a-button"),N=a("router-link"),o=a("a-avatar"),S=a("a-skeleton-line"),q=a("a-tag"),O=a("a-input-search"),T=a("a-space"),$=a("a-table-column"),G=a("a-divider"),A=a("a-switch"),E=a("a-tooltip"),X=a("icon-more"),P=a("a-doption"),Z=a("a-dropdown"),ee=a("a-table");return _(),f("div",Oe,[n("div",Xe,[e(N,{to:{name:"space-datasets-list"}},{default:t(()=>[e(j,{size:"mini",type:"text",class:"!text-gray-700"},{icon:t(()=>[e(C)]),_:1})]),_:1}),n("div",Ze,[e(o,{size:40,shape:"square",class:"rounded-lg","image-url":l(r).icon},null,8,["image-url"]),n("div",et,[(Q=l(r))!=null&&Q.name?(_(),f("div",tt,"知识库 / "+y(l(r).name),1)):(_(),Y(S,{key:0,widths:[100]})),(I=l(r))!=null&&I.name?(_(),f("div",st,[e(q,{size:"small",class:"rounded h-[18px] leading-[18px] bg-gray-200 text-gray-500"},{default:t(()=>{var s;return[g(y((s=l(r))==null?void 0:s.document_count)+" 文档 ",1)]}),_:1}),e(q,{size:"small",class:"rounded h-[18px] leading-[18px] bg-gray-200 text-gray-500"},{default:t(()=>{var s;return[g(y((s=l(r))==null?void 0:s.hit_count)+" 命中 ",1)]}),_:1}),e(q,{size:"small",class:"rounded h-[18px] leading-[18px] bg-gray-200 text-gray-500"},{default:t(()=>{var s;return[g(y((s=l(r))==null?void 0:s.related_app_count)+" 关联应用 ",1)]}),_:1})])):(_(),f("div",at,[e(S,{widths:[60],"line-height":18}),e(S,{widths:[60],"line-height":18}),e(S,{widths:[60],"line-height":18})]))])])]),n("div",lt,[e(O,{"default-value":((W=l(d).query)==null?void 0:W.search_word)||"",placeholder:"请输入关键词搜索文档",class:"w-[240px] bg-white rounded-lg border-gray-200",onSearch:i[0]||(i[0]=s=>{l(v).push({path:l(d).path,query:{search_word:s,current_page:1}})})},null,8,["default-value"]),e(T,{size:12},{default:t(()=>{var s;return[e(j,{class:"rounded-lg",onClick:i[1]||(i[1]=h=>F.value=!0)},{default:t(()=>i[5]||(i[5]=[g("召回测试")])),_:1}),e(N,{to:{name:"space-datasets-documents-create",params:{dataset_id:(s=l(d).params)==null?void 0:s.dataset_id}}},{default:t(()=>[e(j,{type:"primary",class:"rounded-lg"},{default:t(()=>i[6]||(i[6]=[g("添加文件")])),_:1})]),_:1},8,["to"])]}),_:1})]),n("div",ot,[e(ee,{hoverable:"",pagination:{total:l(x).total_record,current:l(x).current_page,defaultCurrent:1,pageSize:l(x).page_size,defaultPageSize:20,showTotal:!0},loading:l(u),data:l(V),bordered:{wrapper:!1},onPageChange:i[2]||(i[2]=s=>{var h;l(v).push({path:l(d).path,query:{current_page:s,search_word:((h=l(d).query)==null?void 0:h.search_word)||""}})})},{columns:t(()=>[e($,{title:"#","data-index":"position",align:"center",width:80,"header-cell-class":"rounded-tl-lg !bg-gray-200 text-gray-700","cell-class":"bg-transparent text-gray-700"}),e($,{title:"文档名","data-index":"name",width:400,"header-cell-class":"!bg-gray-200 text-gray-700","cell-class":"bg-transparent text-gray-700"},{cell:t(({record:s})=>{var h;return[e(N,{to:{name:"space-datasets-documents-segments-list",params:{dataset_id:(h=l(d).params)==null?void 0:h.dataset_id,document_id:s.id}},class:"line-clamp-1 hover:text-gray-900"},{default:t(()=>[g(y(s.name),1)]),_:2},1032,["to"])]}),_:1}),e($,{title:"字符数","data-index":"character_count","header-cell-class":"!bg-gray-200 text-gray-700","cell-class":"bg-transparent text-gray-700"},{cell:t(({record:s})=>[g(y((s.character_count/1e3).toFixed(1))+"k ",1)]),_:1}),e($,{title:"召回次数","data-index":"hit_count","header-cell-class":"!bg-gray-200 text-gray-700","cell-class":"bg-transparent text-gray-700"}),e($,{title:"上传时间","data-index":"created_at","header-cell-class":"!bg-gray-200 text-gray-700","cell-class":"bg-transparent text-gray-700"},{cell:t(({record:s})=>[g(y(l(se)(s.created_at*1e3).format("YYYY-MM-DD HH:mm:ss")),1)]),_:1}),e($,{title:"状态","data-index":"enabled","header-cell-class":"!bg-gray-200 text-gray-700","cell-class":"bg-transparent text-gray-700"},{cell:t(({record:s})=>[e(T,null,{default:t(()=>[s.enabled?(_(),f("div",nt)):(_(),f("div",it)),s.enabled?(_(),f("div",dt,"可用")):(_(),f("div",rt,"已禁用"))]),_:2},1024)]),_:1}),e($,{title:"操作","data-index":"operator","header-cell-class":"rounded-tr-lg !bg-gray-200 text-gray-700","cell-class":"bg-transparent text-gray-700 !h-[40px]",width:100},{cell:t(({record:s,rowIndex:h})=>[e(T,{size:0},{split:t(()=>[e(G,{direction:"vertical"})]),default:t(()=>[s.status==="error"?(_(),Y(E,{key:0,position:"left",content:`错误信息: ${s.error}`},{default:t(()=>[e(A,{size:"small",type:"round","checked-color":"#10b981","unchecked-color":"#556581","default-checked":!1,disabled:""})]),_:2},1032,["content"])):(_(),Y(A,{key:1,size:"small",type:"round","checked-color":"#10b981","unchecked-color":"#556581","model-value":s.enabled,onChange:R=>{var H;l(m)((H=l(d).params)==null?void 0:H.dataset_id,s.id,R,()=>{l(V)[h].enabled=R})}},null,8,["model-value","onChange"])),e(Z,{position:"br"},{content:t(()=>[e(P,{onClick:()=>{w.value=!0,z.value=s.id}},{default:t(()=>i[7]||(i[7]=[g("重命名 ")])),_:2},1032,["onClick"]),e(P,{class:"!text-red-700",onClick:()=>{var R;return l(b)(String((R=l(d).params)==null?void 0:R.dataset_id),s.id,()=>{var H,K;l(D)(String((H=l(d).params)==null?void 0:H.dataset_id),M.value),l(k)(String((K=l(d).params)==null?void 0:K.dataset_id))})}},{default:t(()=>i[8]||(i[8]=[g(" 删除 ")])),_:2},1032,["onClick"])]),default:t(()=>[e(j,{type:"text",size:"mini",class:"!text-gray-700"},{icon:t(()=>[e(X)]),_:1})]),_:2},1024)]),_:2},1024)]),_:1})]),_:1},8,["pagination","loading","data"])]),e(ke,{document_id:z.value,dataset_id:(L=l(d).params)==null?void 0:L.dataset_id,visible:w.value,"onUpdate:visible":i[3]||(i[3]=s=>w.value=s),"on-after-update":()=>{var s;return l(D)(String(((s=l(d).params)==null?void 0:s.dataset_id)??""),M.value)}},null,8,["document_id","dataset_id","visible","on-after-update"]),e(Ke,{visible:F.value,"onUpdate:visible":i[4]||(i[4]=s=>F.value=s),dataset_id:(J=l(d).params)==null?void 0:J.dataset_id},null,8,["visible","dataset_id"])])}}});export{mt as default};
