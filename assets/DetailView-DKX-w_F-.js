import{d as de,r as B,c as g,a as t,f as e,w as o,b as p,x as l,y as n,z as T,B as J,j,h as Q,l as Ee,v as Ne,M as _e,T as Ke,U as be,G as ze,F as se,k as ne,n as ke,A as ve,e as ie,o as Ce,H as at,K as we,u as it,m as rt,C as Je,Q as $e,t as dt}from"./index-Dwc_z1ot.js";import{j as ge,k as ut,l as ct,m as pt,n as _t,o as gt,p as mt,q as vt}from"./use-app-JYWPQSAF.js";import{c as ft,u as xt,s as yt,_ as bt,a as ht,b as wt}from"./AiMessage.vue_vue_type_script_setup_true_lang-Cr1jhSdE.js";import{l as re}from"./lodash-BsIP15WG.js";import{a as kt}from"./use-dataset-BTECfA9z.js";import{f as $t,a as Ct}from"./use-tools-Cs67tX3K.js";import{b as qt,u as St,a as zt}from"./use-builtin-tool-B3mVIryb.js";import{c as Ut}from"./use-workflow-liI-GQ69.js";import{u as Dt,a as At}from"./use-language-model-CpBykXeG.js";const Tt={class:"flex flex-col h-[calc(100vh-173px)]"},jt={class:"flex items-center justify-between px-4 mb-4"},Mt={class:"flex flex-col"},It={key:0,class:"mb-4 flex flex-col"},Bt={class:"max-h-[321px] overflow-scroll scrollbar-w-none mb-2 text-gray-700 whitespace-pre-line"},Lt={class:""},Pt={class:"h-[50px] flex items-center gap-2 px-4 flex-1 border border-gray-200 rounded-full"},Rt={class:"flex-1"},Wt=de({__name:"PresetPromptTextarea",props:{app_id:{type:String,required:!0},preset_prompt:{type:String,default:"",required:!0}},emits:["update:preset_prompt"],setup(w,{emit:A}){const i=w,k=A,r=B(!1),q=B(""),{handleUpdateDraftAppConfig:a}=ge(),{loading:y,optimize_prompt:m,handleOptimizePrompt:x}=ft(),L=()=>{if(m.value.trim()===""){_e.warning("优化prompt为空，请重新生成");return}k("update:preset_prompt",m.value),a(i.app_id,{preset_prompt:m.value}),r.value=!1},P=async()=>{if(q.value.trim()===""){_e.warning("原始prompt不能为空");return}await x(q.value)};return($,b)=>{const v=l("icon-sync"),_=l("a-button"),M=l("a-space"),R=l("icon-send"),V=l("a-card"),O=l("a-trigger"),h=l("a-textarea");return n(),g("div",Tt,[t("div",jt,[b[8]||(b[8]=t("div",{class:"text-gray-700 font-bold"},"人设与回复逻辑",-1)),e(O,{"popup-visible":r.value,"onUpdate:popupVisible":b[2]||(b[2]=d=>r.value=d),trigger:["click"],position:"bl","popup-translate":[0,8]},{content:o(()=>[e(V,{class:"rounded-lg w-[422px]"},{default:o(()=>[t("div",Mt,[p(m)?(n(),g("div",It,[t("div",Bt,T(p(m)),1),p(y)?Q("",!0):(n(),J(M,{key:0},{default:o(()=>[e(_,{size:"small",type:"primary",class:"rounded-lg",onClick:L},{default:o(()=>b[6]||(b[6]=[j(" 替换 ")])),_:1}),e(_,{size:"small",class:"rounded-lg",onClick:b[0]||(b[0]=d=>r.value=!1)},{default:o(()=>b[7]||(b[7]=[j(" 退出 ")])),_:1})]),_:1}))])):Q("",!0),t("div",Lt,[t("div",Pt,[Ee(t("input",{"onUpdate:modelValue":b[1]||(b[1]=d=>q.value=d),type:"text",class:"flex-1 outline-0",placeholder:"你希望如何编写或优化提示词"},null,512),[[Ne,q.value]]),e(_,{loading:p(y),type:"text",shape:"circle",onClick:P},{icon:o(()=>[e(R,{size:16,class:"!text-blue-700"})]),_:1},8,["loading"])])])])]),_:1})]),default:o(()=>[e(_,{size:"mini",class:"rounded-lg px-2"},{icon:o(()=>[e(v)]),default:o(()=>[b[5]||(b[5]=j(" 优化 "))]),_:1})]),_:1},8,["popup-visible"])]),t("div",Rt,[e(h,{class:"h-full resize-none !bg-transparent !border-0 text-gray-700 px-1 preset-prompt-textarea",placeholder:"请在这里输入Agent的人设与回复逻辑(预设prompt)","max-length":2e3,"show-word-limit":"","model-value":i.preset_prompt,"onUpdate:modelValue":b[3]||(b[3]=d=>k("update:preset_prompt",d)),onBlur:b[4]||(b[4]=async()=>{await p(a)(i.app_id,{preset_prompt:i.preset_prompt})})},null,8,["model-value"])])])}}}),Gt={class:""},Ot={class:"flex items-center justify-between border-b h-[64px] px-4"},Ht={class:"flex items-center justify-between"},Ft={class:"pt-6"},Qt={class:"flex items-center justify-between"},Et=de({__name:"PreviewDebugHeader",props:{app_id:{type:String,required:!0},long_term_memory:{type:Object,required:!0}},setup(w){const A=w,{debug_conversation_summary:i,loadDebugConversationSummary:k}=ut(),{loading:r,handleUpdateDebugConversationSummary:q}=ct(),a=B(!1),y=async()=>{await k(A.app_id),a.value=!0};return(m,x)=>{var M;const L=l("icon-save"),P=l("a-button"),$=l("icon-close"),b=l("a-textarea"),v=l("a-space"),_=l("a-modal");return n(),g("div",Gt,[t("div",Ot,[x[6]||(x[6]=t("div",{class:"text-lg text-gray-700"},"预览与调试",-1)),e(P,{disabled:!((M=A.long_term_memory)!=null&&M.enable),size:"mini",type:"text",class:"rounded-lg px-1 !text-blue-700",onClick:y},{icon:o(()=>[e(L)]),default:o(()=>[x[5]||(x[5]=j(" 长期记忆 "))]),_:1},8,["disabled"])]),e(_,{width:520,visible:a.value,"onUpdate:visible":x[4]||(x[4]=R=>a.value=R),"hide-title":"",footer:!1,"modal-class":"rounded-xl"},{default:o(()=>[t("div",Ht,[x[7]||(x[7]=t("div",{class:"text-lg font-bold text-gray-700"},"长期记忆",-1)),e(P,{type:"text",class:"!text-gray-700",size:"small",onClick:x[0]||(x[0]=R=>a.value=!1)},{icon:o(()=>[e($)]),_:1})]),t("div",Ft,[e(b,{"model-value":p(i),"onUpdate:modelValue":x[1]||(x[1]=R=>Ke(i)?i.value=R:null),placeholder:"请输入当前调试会话长期记忆","show-word-limit":"","max-length":2e3,"auto-size":{minRows:8,maxRows:8}},null,8,["model-value"]),t("div",Qt,[x[10]||(x[10]=t("div",{class:""},null,-1)),e(v,{size:16},{default:o(()=>[e(P,{class:"rounded-lg",onClick:x[2]||(x[2]=R=>a.value=!1)},{default:o(()=>x[8]||(x[8]=[j("取消")])),_:1}),e(P,{loading:p(r),type:"primary",class:"rounded-lg",onClick:x[3]||(x[3]=async()=>{await p(q)(A.app_id,p(i)),a.value=!1})},{default:o(()=>x[9]||(x[9]=[j(" 保存 ")])),_:1},8,["loading"])]),_:1})])])]),_:1},8,["visible"])])}}}),Nt={class:""},Kt=de({__name:"LongTermMemoryAbilityItem",props:{app_id:{type:String,default:"",required:!0},long_term_memory:{type:Object,default:()=>({enable:!1}),required:!0}},emits:["update:long_term_memory"],setup(w,{emit:A}){const i=w,k=A,{handleUpdateDraftAppConfig:r}=ge();return(q,a)=>{const y=l("icon-down"),m=l("a-button"),x=l("a-doption"),L=l("a-dropdown"),P=l("a-collapse-item");return n(),g("div",Nt,[e(P,{key:"long_term_memory",class:"app-ability-item"},{header:o(()=>a[2]||(a[2]=[t("div",{class:"text-gray-700 font-bold"},"长期记忆",-1)])),extra:o(()=>[e(L,{onSelect:a[1]||(a[1]=async $=>{var b;console.log(i),!!$!==((b=i.long_term_memory)==null?void 0:b.enable)&&(k("update:long_term_memory",{enable:!!$}),await p(r)(i.app_id,{long_term_memory:{enable:!!$}}))})},{content:o(()=>[e(x,{value:1,class:"text-xs py-1.5 text-gray-700"},{default:o(()=>a[3]||(a[3]=[j("开启")])),_:1}),e(x,{value:0,class:"text-xs py-1.5 text-red-700"},{default:o(()=>a[4]||(a[4]=[j("关闭")])),_:1})]),default:o(()=>[e(m,{size:"mini",class:"rounded-lg flex items-center gap-1 px-1",onClick:a[0]||(a[0]=be(()=>{},["stop"]))},{default:o(()=>[j(T(i.long_term_memory.enable?"开启":"关闭")+" ",1),e(y)]),_:1})]),_:1})]),default:o(()=>[a[5]||(a[5]=t("div",{class:"text-xs text-gray-500 leading-[22px]"}," 总结聊天对话内容，并用于更好的响应用户的信息。 ",-1))]),_:1})])}}}),Jt={class:""},Vt={class:"text-xs text-gray-500"},Xt={class:"flex flex-col gap-2 mb-2"},Yt={class:"flex items-center gap-2"},Zt={class:"flex flex-col gap-2 mb-2"},eo={class:"flex items-center gap-2"},to={class:"flex flex-col gap-2"},oo=de({__name:"OpeningAbilityItem",props:{app_id:{type:String,default:"",required:!0},opening_statement:{type:String,default:"",required:!0},opening_questions:{type:Array,default:[],required:!0}},emits:["update:opening_statement","update:opening_questions"],setup(w,{emit:A}){const i=w,k=A,{handleUpdateDraftAppConfig:r}=ge(),q=ze({get(){const y=[...i.opening_questions];return y.length<3&&y[y.length-1]!==""&&y.push(""),y},set(y){k("update:opening_questions",y)}}),a=async()=>{await r(i.app_id,{opening_questions:q.value.filter(y=>y.trim()!=="")})};return(y,m)=>{const x=l("icon-exclamation-circle"),L=l("a-tooltip"),P=l("a-textarea"),$=l("a-input"),b=l("icon-delete"),v=l("a-button"),_=l("a-collapse-item");return n(),g("div",Jt,[e(_,{key:"opening",class:"app-ability-item"},{header:o(()=>m[3]||(m[3]=[t("div",{class:"text-gray-700 font-bold"},"对话开场白",-1)])),default:o(()=>[t("div",Vt,[t("div",Xt,[t("div",Yt,[m[4]||(m[4]=t("div",{class:"text-gray-700"},"开场白文案",-1)),e(L,{content:"开场白是与Agent应用对话时，Agent默认展示的对话。"},{default:o(()=>[e(x)]),_:1})]),e(P,{"model-value":i.opening_statement,"onUpdate:modelValue":m[0]||(m[0]=M=>k("update:opening_statement",M)),placeholder:"在此处填写 AI 应用的开场白",class:"bg-white text-gray-700 rounded-lg border border-gray-200","auto-size":{minRows:4,maxRows:4},onBlur:m[1]||(m[1]=async()=>{await p(r)(i.app_id,{opening_statement:i.opening_statement})})},null,8,["model-value"])]),t("div",Zt,[t("div",eo,[m[5]||(m[5]=t("div",{class:"text-gray-700"},"开场白预设问题",-1)),e(L,{content:"开场白预设问题是与Agent对话时，初始化提供的建议问题，最多不超过3个"},{default:o(()=>[e(x)]),_:1})]),t("div",to,[(n(!0),g(se,null,ne(q.value,(M,R)=>(n(),g("div",{key:R,class:"flex items-center gap-2"},[e($,{"model-value":M,"onUpdate:modelValue":V=>{const O=[...q.value];O[R]=V,q.value=O},class:"rounded-lg bg-white",placeholder:"输入开场白引导问题",onBlur:m[2]||(m[2]=async()=>await a())},null,8,["model-value","onUpdate:modelValue"]),e(v,{class:"rounded-lg",onClick:async()=>{const V=[...q.value];V.splice(R,1),k("update:opening_questions",V),await ke(),await a()}},{icon:o(()=>[e(b)]),_:2},1032,["onClick"])]))),128))])])])]),_:1})])}}}),lo={class:""},so=de({__name:"SuggestedAfterAnswerAbilityItem",props:{app_id:{type:String,default:"",required:!0},suggested_after_answer:{type:Object,default:()=>({enable:!1}),required:!0}},emits:["update:suggested_after_answer"],setup(w,{emit:A}){const i=w,k=A,{handleUpdateDraftAppConfig:r}=ge();return(q,a)=>{const y=l("icon-down"),m=l("a-button"),x=l("a-doption"),L=l("a-dropdown"),P=l("a-collapse-item");return n(),g("div",lo,[e(P,{key:"suggested_after_answer",class:"app-ability-item"},{header:o(()=>a[2]||(a[2]=[t("div",{class:"text-gray-700 font-bold"},"用户问题建议",-1)])),extra:o(()=>[e(L,{onSelect:a[1]||(a[1]=async $=>{var b;!!$!==((b=i.suggested_after_answer)==null?void 0:b.enable)&&(k("update:suggested_after_answer",{enable:!!$}),await p(r)(i.app_id,{suggested_after_answer:{enable:!!$}}))})},{content:o(()=>[e(x,{value:1,class:"text-xs py-1.5 text-gray-700"},{default:o(()=>a[3]||(a[3]=[j("开启")])),_:1}),e(x,{value:0,class:"text-xs py-1.5 text-red-700"},{default:o(()=>a[4]||(a[4]=[j("关闭")])),_:1})]),default:o(()=>[e(m,{size:"mini",class:"rounded-lg flex items-center gap-1 px-1",onClick:a[0]||(a[0]=be(()=>{},["stop"]))},{default:o(()=>{var $;return[j(T(($=i.suggested_after_answer)!=null&&$.enable?"开启":"关闭")+" ",1),e(y)]}),_:1})]),_:1})]),default:o(()=>[a[5]||(a[5]=t("div",{class:"text-xs text-gray-500 leading-[22px]"}," 在应用回复后，自动根据对话内容提供 3 条用户提问建议 ",-1))]),_:1})])}}}),no={class:""},ao={class:"group py-2"},io={class:"flex items-center justify-between"},ro={class:"py-4"},uo={class:"flex flex-col gap-5"},co={class:"flex flex-col gap-2"},po={class:"flex flex-col gap-2 p-3 bg-gray-50 border border-gray-200 rounded-lg"},_o={class:"flex items-center justify-between"},go={class:"flex flex-col gap-2"},mo={class:"flex flex-col p-3 bg-gray-50 border border-gray-200 rounded-lg"},vo={class:"flex items-center justify-between"},fo={class:"flex items-center justify-between"},xo=de({__name:"ReviewConfigAbilityItem",props:{app_id:{type:String,default:"",required:!0},review_config:{type:Object,default:{},required:!0}},setup(w){var P,$,b,v,_,M,R,V,O;const A=w,{loading:i,handleUpdateDraftAppConfig:k}=ge(),r=B(!1),q=B(!1),a=B({enable:(P=A.review_config)==null?void 0:P.enable,keywords:(b=($=A.review_config)==null?void 0:$.keywords)==null?void 0:b.join(`
`),inputs_config:{enable:(_=(v=A.review_config)==null?void 0:v.inputs_config)==null?void 0:_.enable,preset_response:(R=(M=A.review_config)==null?void 0:M.inputs_config)==null?void 0:R.preset_response},outputs_config:{enable:(O=(V=A.review_config)==null?void 0:V.outputs_config)==null?void 0:O.enable}}),y=B({...re.cloneDeep(a.value)}),m=()=>re.isEqual(y.value,a.value),x=()=>{q.value=!1,a.value=re.cloneDeep(y.value)},L=async()=>{try{await k(A.app_id,{review_config:{enable:a.value.enable,keywords:a.value.keywords.split(/\r?\n/).filter(h=>h.trim()!==""),inputs_config:a.value.inputs_config,outputs_config:a.value.outputs_config}}),y.value=re.cloneDeep(a.value),await ke(),x()}catch{}};return ve(()=>A.review_config,h=>{(!r.value||!m())&&h&&Object.keys(h).length>0&&(a.value=re.cloneDeep({...h,keywords:h==null?void 0:h.keywords.join(`
`)}),y.value=re.cloneDeep({...h,keywords:h==null?void 0:h.keywords.join(`
`)}),r.value=!0)},{immediate:!0,deep:!0}),(h,d)=>{const G=l("icon-down"),te=l("a-button"),X=l("a-doption"),ae=l("a-dropdown"),S=l("icon-settings"),u=l("a-collapse-item"),f=l("icon-close"),E=l("a-textarea"),Y=l("a-switch"),H=l("a-space"),Z=l("a-modal");return n(),g("div",no,[e(u,{key:"review_config",class:"app-ability-item review-config-ability-item"},{header:o(()=>d[7]||(d[7]=[t("div",{class:"text-gray-700 font-bold"},"内容审查",-1)])),extra:o(()=>[e(ae,{onSelect:d[1]||(d[1]=async U=>{if(!!U!==a.value.enable)try{a.value.enable=!!U,await ke(),await L()}catch{}})},{content:o(()=>[e(X,{value:1,class:"text-xs py-1.5 text-gray-700"},{default:o(()=>d[8]||(d[8]=[j("开启")])),_:1}),e(X,{value:0,class:"text-xs py-1.5 text-red-700"},{default:o(()=>d[9]||(d[9]=[j("关闭")])),_:1})]),default:o(()=>[e(te,{size:"mini",class:"rounded-lg flex items-center gap-1 px-1",onClick:d[0]||(d[0]=be(()=>{},["stop"]))},{default:o(()=>[j(T(a.value.enable?"开启":"关闭")+" ",1),e(G)]),_:1})]),_:1})]),default:o(()=>[t("div",ao,[d[11]||(d[11]=t("div",{class:"text-xs text-gray-500 leading-[22px] group-hover:hidden"}," 对用户输入以及大语言模型输出内容进行审查。 ",-1)),e(te,{size:"small",long:"",class:"hidden group-hover:block rounded-lg transition-all",onClick:d[2]||(d[2]=U=>q.value=!0)},{icon:o(()=>[e(S)]),default:o(()=>[d[10]||(d[10]=j(" 设置 "))]),_:1})])]),_:1}),e(Z,{visible:q.value,"hide-title":"",footer:!1,"modal-class":"rounded-xl",onCancel:x},{default:o(()=>[t("div",io,[d[12]||(d[12]=t("div",{class:"text-lg font-bold text-gray-700"},"内容审核",-1)),e(te,{type:"text",class:"!text-gray-700",size:"small",onClick:x},{icon:o(()=>[e(f)]),_:1})]),t("div",ro,[t("div",uo,[t("div",co,[d[13]||(d[13]=t("div",{class:"flex flex-col"},[t("div",{class:"flex items-center gap-1 text-gray-700"},[j(" 关键词 "),t("div",{class:"text-red-700"},"*")]),t("div",{class:"text-gray-500 text-xs"},"每行一个，用换行符分割，最多填写100个关键词")],-1)),e(E,{"model-value":a.value.keywords,"onUpdate:modelValue":d[3]||(d[3]=U=>a.value.keywords=U),class:"bg-white rounded-lg border border-gray-200",placeholder:"每行一个，用换行符分隔。","max-length":100,"show-word-limit":"","auto-size":{minRows:4,maxRows:4},"word-length":U=>U.trim()===""?0:U.split(/\r?\n/).length,"word-slice":(U,N)=>U.split(/\r?\n/).slice(0,N).join(`
`)},null,8,["model-value","word-length","word-slice"])]),t("div",po,[t("div",_o,[d[14]||(d[14]=t("div",{class:"text-gray-700"},"输入审查内容",-1)),e(Y,{"model-value":a.value.inputs_config.enable,"onUpdate:modelValue":d[4]||(d[4]=U=>a.value.inputs_config.enable=U),size:"small",type:"round","checked-color":"#10b981","unchecked-color":"#556581"},null,8,["model-value"])]),t("div",go,[d[15]||(d[15]=t("div",{class:"text-gray-700 text-xs"},"预设回复",-1)),e(E,{"model-value":a.value.inputs_config.preset_response,"onUpdate:modelValue":d[5]||(d[5]=U=>a.value.inputs_config.preset_response=U),placeholder:"这里是预设回复内容",class:"bg-white rounded-lg border border-gray-200","auto-size":{minRows:3,maxRows:3}},null,8,["model-value"])])]),t("div",mo,[t("div",vo,[d[16]||(d[16]=t("div",{class:"text-gray-700"},"输出审查内容",-1)),e(Y,{"model-value":a.value.outputs_config.enable,"onUpdate:modelValue":d[6]||(d[6]=U=>a.value.outputs_config.enable=U),size:"small",type:"round","checked-color":"#10b981","unchecked-color":"#556581"},null,8,["model-value"])])])])]),t("div",fo,[d[19]||(d[19]=t("div",{class:""},null,-1)),e(H,{size:16},{default:o(()=>[e(te,{class:"rounded-lg",onClick:x},{default:o(()=>d[17]||(d[17]=[j("取消")])),_:1}),e(te,{loading:p(i),type:"primary",class:"rounded-lg",onClick:L},{default:o(()=>d[18]||(d[18]=[j(" 保存 ")])),_:1},8,["loading"])]),_:1})])]),_:1},8,["visible"])])}}}),yo={class:""},bo={key:0,class:""},ho={key:1,class:""},wo={key:2,class:""},ko={key:0,class:"flex flex-col gap-1"},$o={class:"flex items-center gap-2"},Co={class:"flex flex-col flex-1 gap-1 h-9"},qo={class:"text-gray-700 font-bold leading-[18px] line-clamp-1 break-all"},So={class:"text-gray-500 text-xs line-clamp-1 break-all"},zo={key:1,class:"text-xs text-gray-500 leading-[22px]"},Uo={class:"flex items-center justify-between mb-6"},Do={class:"h-[calc(100vh-180px)] mb-4 overflow-scroll scrollbar-w-none"},Ao={class:"flex flex-col gap-2"},To=["onClick"],jo={class:"line-clamp-1 text-gray-500 flex-1"},Mo={class:"flex items-center justify-between"},Io={class:""},Bo={class:"flex items-center justify-between"},Lo={class:"flex items-center gap-4 w-full pl-3"},Po={class:"flex items-center gap-4 w-full pl-3"},Ro={class:"flex items-center justify-between"},Wo=de({__name:"DatasetsAbilityItem",props:{app_id:{type:String,default:"",required:!0},retrieval_config:{type:Object,default:()=>({}),required:!0},datasets:{type:Array,default:()=>[],required:!0}},emits:["update:datasets","update:retrieval_config"],setup(w,{emit:A}){const i=w,k=A,{loading:r,handleUpdateDraftAppConfig:q}=ge(),{loading:a,paginator:y,datasets:m,loadDatasets:x}=kt(),L=B(!1),P=B(!1),$=B(!1),b=B([]),v=B([]),_=B({}),M=B({}),R=B(!1),V=async S=>{const{scrollTop:u,scrollHeight:f,clientHeight:E}=S.target;if(u+E>=f-10){if(a.value)return;await x()}},O=()=>re.isEqual(b.value,v.value),h=()=>re.isEqual(_.value,M.value),d=()=>{L.value=!1,b.value=v.value,$.value=!1},G=()=>{P.value=!1,_.value=M.value,R.value=!1},te=S=>{const u=m.value[S];if(b.value.some(f=>f.id===u.id))b.value=b.value.filter(f=>f.id!==u.id);else{if(b.value.length>=5){_e.warning("关联知识库已超过5个，无法继续关联");return}b.value.push({id:u.id,name:u.name,icon:u.icon,description:u.description})}},X=async()=>{try{await q(i.app_id,{datasets:b.value.map(S=>S.id)}),v.value=b.value,await ke(),k("update:datasets",b.value),d()}catch(S){_e.error(S.message)}},ae=async()=>{try{await q(i.app_id,{retrieval_config:_.value}),M.value=_.value,k("update:retrieval_config",_.value),G()}catch(S){_e.error(S.message)}};return ve(()=>i.datasets,S=>{if((!$.value||!O())&&S&&S.length>0){const u=i.datasets.map(f=>({id:f.id,name:f.name,icon:f.icon,description:f.description}));b.value=re.cloneDeep(u),v.value=re.cloneDeep(u),$.value=!0}},{immediate:!0,deep:!0}),ve(()=>i.retrieval_config,S=>{(!R.value||!h())&&S&&Object.keys(S).length>0&&(_.value={...S},M.value={...S},R.value=!0)},{immediate:!0,deep:!0}),ve(()=>L.value,async S=>{S?await x(!0):m.value.splice(0,m.value.length)}),(S,u)=>{const f=l("icon-language"),E=l("a-button"),Y=l("icon-plus"),H=l("a-space"),Z=l("a-avatar"),U=l("icon-delete"),N=l("a-collapse-item"),ee=l("icon-close"),oe=l("a-empty"),s=l("a-spin"),c=l("a-col"),z=l("a-row"),C=l("a-modal"),D=l("a-radio-group"),I=l("a-form-item"),le=l("a-slider"),fe=l("a-input-number"),qe=l("a-form");return n(),g("div",yo,[e(N,{key:"datasets",class:"app-ability-item"},{header:o(()=>u[7]||(u[7]=[t("div",{class:"text-gray-700 font-bold"},"知识库",-1)])),extra:o(()=>[e(H,null,{default:o(()=>[e(E,{size:"mini",class:"rounded-lg px-2",onClick:u[0]||(u[0]=be(F=>P.value=!0,["stop"]))},{icon:o(()=>[e(f)]),default:o(()=>{var F,me;return[((F=w.retrieval_config)==null?void 0:F.retrieval_strategy)==="semantic"?(n(),g("div",bo," 相似度检索 ")):((me=w.retrieval_config)==null?void 0:me.retrieval_strategy)==="full_text"?(n(),g("div",ho," 全文检索 ")):(n(),g("div",wo,"混合检索"))]}),_:1}),e(E,{size:"mini",type:"text",class:"!text-gray-700",onClick:u[1]||(u[1]=be(F=>L.value=!0,["stop"]))},{icon:o(()=>[e(Y)]),_:1})]),_:1})]),default:o(()=>[i.datasets.length>0?(n(),g("div",ko,[(n(!0),g(se,null,ne(i.datasets,(F,me)=>(n(),g("div",{key:F.id,class:"flex items-center justify-between bg-white p-3 rounded-lg cursor-pointer hover:shadow-sm group"},[t("div",$o,[e(Z,{size:36,shape:"square",class:"rounded flex-shrink-0","image-url":F.icon},null,8,["image-url"]),t("div",Co,[t("div",qo,T(F.name),1),t("div",So,T(F.description),1)])]),e(E,{size:"mini",type:"text",class:"hidden group-hover:block flex-shrink-0 ml-2 !text-red-700 rounded",onClick:async()=>{const xe=[...i.datasets];xe.splice(me,1),await p(q)(i.app_id,{datasets:xe.map(Se=>Se.id)}),$.value=!1,k("update:datasets",xe)}},{icon:o(()=>[e(U)]),_:2},1032,["onClick"])]))),128))])):(n(),g("div",zo," 引用文本类型的数据，实现知识问答，应用最多支持关联 5 个知识库。 "))]),_:1}),e(C,{visible:L.value,"hide-title":"",footer:!1,width:400,class:"datasets-modal","modal-class":"h-[calc(100vh-32px)] right-4",onCancel:d},{default:o(()=>[t("div",Uo,[u[8]||(u[8]=t("div",{class:"text-lg font-bold text-gray-700"},"选择引用知识库",-1)),e(E,{type:"text",class:"!text-gray-700",size:"small",onClick:d},{icon:o(()=>[e(ee)]),_:1})]),t("div",Do,[e(s,{loading:p(a),class:"block h-full scrollbar-w-none overflow-scroll",onScroll:V},{default:o(()=>[t("div",Ao,[(n(!0),g(se,null,ne(p(m),(F,me)=>(n(),g("div",{key:F.id,class:ie(`flex items-center gap-2 border px-3 py-2 rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-700 ${b.value.some(xe=>xe.id===F.id)?"bg-blue-50 border-blue-700":""}`),onClick:()=>te(me)},[e(Z,{size:24,shape:"square",class:"flex-shrink-0 rounded","image-url":F.icon},null,8,["image-url"]),t("div",jo,T(F.name),1)],10,To))),128)),p(m).length===0?(n(),J(oe,{key:0,description:"没有可用知识库",class:"h-[400px] flex flex-col items-center justify-center"})):Q("",!0)]),p(y).total_page>=2?(n(),J(z,{key:0},{default:o(()=>[p(y).current_page<=p(y).total_page?(n(),J(c,{key:0,span:24,class:"!text-center"},{default:o(()=>[e(H,{class:"my-4"},{default:o(()=>[e(s),u[9]||(u[9]=t("div",{class:"text-gray-400"},"加载中",-1))]),_:1})]),_:1})):(n(),J(c,{key:1,span:24,class:"!text-center"},{default:o(()=>u[10]||(u[10]=[t("div",{class:"text-gray-400 my-4"},"数据已加载完成",-1)])),_:1}))]),_:1})):Q("",!0)]),_:1},8,["loading"])]),t("div",Mo,[t("div",Io,T(b.value.length)+"个知识库被选中",1),e(H,{size:12},{default:o(()=>[e(E,{class:"rounded-lg",onClick:d},{default:o(()=>u[11]||(u[11]=[j("取消")])),_:1}),e(E,{loading:p(r),type:"primary",class:"rounded-lg",onClick:X},{default:o(()=>u[12]||(u[12]=[j(" 添加 ")])),_:1},8,["loading"])]),_:1})])]),_:1},8,["visible"]),e(C,{visible:P.value,"hide-title":"",footer:!1,"modal-class":"rounded-xl",onCancel:G},{default:o(()=>[t("div",Bo,[u[13]||(u[13]=t("div",{class:"text-lg font-bold text-gray-700"},"检索设置",-1)),e(E,{type:"text",class:"!text-gray-700",size:"small",onClick:G},{icon:o(()=>[e(ee)]),_:1})]),e(qe,{model:_.value,onSubmit:ae,class:"pt-6"},{default:o(()=>[e(I,{field:"retrieval_strategy",label:"检索策略","label-align":"left"},{default:o(()=>[e(D,{"model-value":_.value.retrieval_strategy,"onUpdate:modelValue":u[2]||(u[2]=F=>_.value.retrieval_strategy=F),"default-value":"semantic",options:[{label:"混合策略",value:"hybrid"},{label:"全文检索",value:"full_text"},{label:"相似性检索",value:"semantic"}]},null,8,["model-value"])]),_:1}),e(I,{field:"k",label:"最大召回数量"},{default:o(()=>[t("div",Lo,[e(le,{"model-value":_.value.k,"onUpdate:modelValue":u[3]||(u[3]=F=>_.value.k=F),step:1,min:1,max:10},null,8,["model-value"]),e(fe,{"model-value":_.value.k,"onUpdate:modelValue":u[4]||(u[4]=F=>_.value.k=F),class:"w-[80px]","default-value":4},null,8,["model-value"])])]),_:1}),e(I,{field:"score",label:"最小匹配度"},{default:o(()=>[t("div",Po,[e(le,{"model-value":_.value.score,"onUpdate:modelValue":u[5]||(u[5]=F=>_.value.score=F),step:.01,min:0,max:.99},null,8,["model-value"]),e(fe,{"model-value":_.value.score,"onUpdate:modelValue":u[6]||(u[6]=F=>_.value.score=F),class:"w-[80px]",min:0,max:.99,step:.01,precision:2,"default-value":.5},null,8,["model-value"])])]),_:1}),t("div",Ro,[u[16]||(u[16]=t("div",{class:""},null,-1)),e(H,{size:16},{default:o(()=>[e(E,{class:"rounded-lg",onClick:G},{default:o(()=>u[14]||(u[14]=[j("取消")])),_:1}),e(E,{loading:p(r),type:"primary","html-type":"submit",class:"rounded-lg"},{default:o(()=>u[15]||(u[15]=[j("保存")])),_:1},8,["loading"])]),_:1})])]),_:1},8,["model"])]),_:1},8,["visible"])])}}}),Go={class:""},Oo={key:0,class:"flex flex-col gap-1"},Ho={class:"flex items-center gap-2"},Fo={class:"flex flex-col gap-1 h-9"},Qo={class:"text-gray-700 font-bold leading-[18px] line-clamp-1 break-all"},Eo={class:"text-gray-500 text-xs line-clamp-1 break-all"},No={class:"hidden group-hover:flex items-center gap-1 flex-shrink-0 ml-2"},Ko={key:1,class:"text-xs text-gray-500 leading-[22px]"},Jo={class:"flex items-center justify-between mb-6"},Vo={class:"flex items-center"},Xo={class:"flex items-center gap-2"},Yo={class:"text-gray-700 font-bold max-w-[200px] line-clamp-1 break-all"},Zo={class:"mx-4 text-gray-400"},el={class:"flex items-center gap-6"},tl={key:0,class:"h-[calc(100vh-170px)] pb-4 overflow-scroll scrollbar-w-none"},ol={class:"text-gray-500 text-xs"},ll={key:0,class:""},sl={class:"flex flex-col gap-4"},nl={class:"flex items-center gap-2 text-xs"},al={class:"text-gray-900 font-bold"},il={class:"text-gray-500"},rl={key:0,class:"text-red-700"},dl={class:"text-xs text-gray-500"},ul={key:1,class:"h-[calc(100vh-170px)] pb-4 overflow-scroll scrollbar-w-none"},cl={class:"flex items-center gap-1"},pl={class:"text-gray-700"},_l={key:0,class:"text-red-700"},gl={class:"flex items-center justify-between"},ml={class:"flex w-full h-full"},vl={class:"flex flex-col flex-shrink-0 bg-gray-50 w-[200px] h-full px-3 py-4 overflow-scroll scrollbar-w-none"},fl={class:"flex flex-col gap-1 mb-4"},xl={key:0,class:""},yl={class:"flex flex-col gap-1"},bl=["onClick"],hl=["innerHTML"],wl={class:"flex-1 p-4"},kl={class:"w-full flex items-center justify-between gap-2 mb-7"},$l={class:"text-lg font-bold text-gray-700"},Cl={key:0,class:"h-[calc(100vh-130px)] overflow-scroll scrollbar-w-none"},ql={class:"text-gray-900"},Sl={class:"flex flex-col gap-1"},zl={class:"flex items-center gap-2"},Ul={class:"text-gray-900"},Dl={key:0,class:""},Al={key:1},Tl={class:"text-gray-900"},jl={class:"flex flex-col gap-1"},Ml={class:"flex items-center gap-2"},Il={class:"text-gray-900"},Bl={key:0,class:""},Ll=de({__name:"ToolsAbilityItem",props:{app_id:{type:String,default:"",required:!0},tools:{type:Array,default:[],required:!0}},emits:["update:tools"],setup(w,{emit:A}){const i=w,k=A,{loading:r,handleUpdateDraftAppConfig:q}=ge(),{loading:a,api_tool:y,loadApiTool:m}=$t(),{loading:x,paginator:L,api_tool_providers:P,loadApiToolProviders:$}=Ct(),{loading:b,builtin_tool:v,loadBuiltinTool:_}=qt(),{categories:M,loadCategories:R}=St(),{builtin_tools:V,loadBuiltinTools:O}=zt(),h=B(!1),d=B("info"),G=B({}),te=B(-1),X=B({}),ae=B(!1),S=B("api_tool"),u=B("all"),f=ze(()=>u.value==="all"?V.value:V.value.filter(s=>s.category===u.value)),E=async s=>{if(s===-1)return;te.value=s;const c=i.tools[s];c.type==="builtin_tool"?(await _(c.provider.name,c.tool.name),G.value={type:"builtin_tool",provider:{id:v.value.provider.name,icon:`${we}/builtin-tools/${v.value.provider.name}/icon`,name:v.value.provider.name,label:v.value.provider.label,description:v.value.provider.description},tool:{id:v.value.name,name:v.value.name,label:v.value.label,description:v.value.description,inputs:v.value.inputs,params:v.value.params}}):(await m(c.provider.id,c.tool.name),G.value={type:"api_tool",provider:{id:y.value.provider.id,icon:y.value.provider.icon,name:y.value.provider.name,label:y.value.provider.name,description:y.value.provider.description},tool:{id:y.value.name,name:y.value.name,label:y.value.name,description:y.value.description,inputs:v.value.inputs,params:[]}});const z=c.tool.params;G.value.tool.params.forEach(C=>{X.value[C.name]=z[C.name]??C.default}),h.value=!0},Y=()=>{te.value=-1,h.value=!1,d.value="info"},H=async()=>{if(i.tools[te.value].type==="api_tool"){Y();return}const c=[...i.tools];c[te.value].tool.params=X.value,await q(i.app_id,{tools:c.map(z=>({type:z.type,params:z.tool.params,provider_id:z.provider.id,tool_id:z.tool.name}))}),k("update:tools",c),Y()},Z=async s=>{const c=[...i.tools];c.splice(s,1),await q(i.app_id,{tools:c.map(z=>({type:z.type,params:z.tool.params,provider_id:z.provider.id,tool_id:z.tool.name}))}),k("update:tools",c)},U=async()=>{ae.value=!0,await $(!0),await O()},N=async s=>{const{scrollTop:c,scrollHeight:z,clientHeight:C}=s.target;if(c+C>=z-10){if(x.value)return;await $()}},ee=async(s,c)=>{let z={};if(S.value==="api_tool"){const C=P.value[s],D=C.tools[c];z={type:"api_tool",provider:{id:C.id,name:C.name,label:C.name,icon:C.icon,description:C.description},tool:{id:D.name,name:D.name,label:D.name,description:D.description,params:{}}}}else{const C=f.value[s],D=C.tools[c],I=D.params;z={type:"builtin_tool",provider:{id:C.name,name:C.name,label:C.label,icon:`${we}/builtin-tools/${C.name}/icon`,description:C.description},tool:{id:D.name,name:D.name,label:D.label,description:D.description,params:I.reduce((le,fe)=>(le[fe.name]=fe.default,le),{})}}}if(i.tools.some(C=>C.provider.id===z.provider.id&&C.tool.name===z.tool.name)){const C=[...i.tools].filter(D=>D.provider.id!==z.provider.id&&D.tool.name!==z.tool.name);await q(i.app_id,{tools:C.map(D=>({type:D.type,params:D.tool.params,provider_id:D.provider.id,tool_id:D.tool.name}))}),k("update:tools",C);return}else{if(i.tools.length>=5){_e.warning("一个Agent应用最多关联5个扩展插件");return}const C=[...i.tools];C.push(z),await q(i.app_id,{tools:C.map(D=>({type:D.type,params:D.tool.params,provider_id:D.provider.id,tool_id:D.tool.name}))}),k("update:tools",C)}},oe=(s,c)=>i.tools.some(z=>z.provider.name===s.name&&z.tool.name===c.name);return Ce(()=>{R()}),(s,c)=>{const z=l("icon-plus"),C=l("a-button"),D=l("a-avatar"),I=l("icon-settings"),le=l("icon-delete"),fe=l("a-collapse-item"),qe=l("icon-oblique-line"),F=l("icon-close"),me=l("icon-info-circle"),xe=l("a-tooltip"),Se=l("a-select"),Ve=l("a-input"),Xe=l("a-input-number"),Ue=l("a-radio"),Ye=l("a-radio-group"),Ze=l("a-form-item"),et=l("a-form"),De=l("a-space"),Ae=l("a-modal"),tt=l("router-link"),ot=l("icon-code"),lt=l("icon-translate"),st=l("icon-apps"),Te=l("a-empty"),je=l("a-spin"),Me=l("a-col"),nt=l("a-row");return n(),g("div",Go,[e(fe,{key:"tools",class:"app-ability-item"},{header:o(()=>c[7]||(c[7]=[t("div",{class:"text-gray-700 font-bold"},"扩展插件",-1)])),extra:o(()=>[e(C,{size:"mini",type:"text",class:"!text-gray-700",onClick:be(U,["stop"])},{icon:o(()=>[e(z)]),_:1})]),default:o(()=>[i.tools.length>0?(n(),g("div",Oo,[(n(!0),g(se,null,ne(i.tools,(W,pe)=>(n(),g("div",{key:pe,class:"flex items-center justify-between bg-white p-3 rounded-lg cursor-pointer hover:shadow-sm group"},[t("div",Ho,[e(D,{size:36,shape:"square",class:"rounded flex-shrink-0","image-url":W.provider.icon},null,8,["image-url"]),t("div",Fo,[t("div",Qo,T(W.provider.label)+" / "+T(W.tool.label),1),t("div",Eo,T(W.tool.description),1)])]),t("div",No,[e(C,{loading:p(a)||p(b),size:"mini",type:"text",class:"!text-gray-700 rounded",onClick:async()=>await E(pe)},{icon:o(()=>[e(I)]),_:2},1032,["loading","onClick"]),e(C,{loading:p(r),size:"mini",type:"text",class:"!text-red-700 rounded",onClick:async()=>await Z(pe)},{icon:o(()=>[e(le)]),_:2},1032,["loading","onClick"])])]))),128))])):(n(),g("div",Ko," 插件能够让智能体调用外部 API，例如搜索信息、浏览网页、生成图片等，扩展智能体的能力和使用场景。 "))]),_:1}),e(Ae,{visible:h.value,"hide-title":"",footer:!1,class:"tool-setting-modal","modal-class":"h-[calc(100vh-32px)] right-4",onCancel:Y},{default:o(()=>{var W,pe,ue,he,Ie,Be,Le,Pe,Re,We,Ge,Oe,He,Fe;return[t("div",Jo,[t("div",Vo,[t("div",Xo,[e(D,{size:24,shape:"circle","image-url":(pe=(W=G.value)==null?void 0:W.provider)==null?void 0:pe.icon},null,8,["image-url"]),t("div",Yo,T((he=(ue=G.value)==null?void 0:ue.tool)==null?void 0:he.label),1)]),t("div",Zo,[e(qe,{size:12})]),t("div",el,[t("div",{class:ie(`text-gray-700 pt-1 cursor-pointer border-blue-700 hover:border-b-4 hover:font-bold transition-all ${d.value==="info"?"font-bold border-b-4":""}`),onClick:c[0]||(c[0]=ce=>d.value="info")}," 信息 ",2),G.value.type==="builtin_tool"&&((Le=(Be=(Ie=G.value)==null?void 0:Ie.tool)==null?void 0:Be.params)==null?void 0:Le.length)>0?(n(),g("div",{key:0,class:ie(`text-gray-700 pt-1 cursor-pointer border-blue-700 hover:border-b-4 hover:font-bold transition-all ${d.value==="setting"?"font-bold border-b-4":""}`),onClick:c[1]||(c[1]=ce=>d.value="setting")}," 设置 ",2)):Q("",!0)])]),e(C,{size:"mini",type:"text",class:"!text-gray-700",onClick:Y},{icon:o(()=>[e(F)]),_:1})]),d.value==="info"?(n(),g("div",tl,[c[9]||(c[9]=t("div",{class:"text-gray-70 font-bold mb-1"},"工具描述",-1)),t("div",ol,T((Re=(Pe=G.value)==null?void 0:Pe.tool)==null?void 0:Re.description),1),((Oe=(Ge=(We=G.value)==null?void 0:We.tool)==null?void 0:Ge.inputs)==null?void 0:Oe.length)>0?(n(),g("div",ll,[c[8]||(c[8]=t("div",{class:"flex items-center gap-2 my-4"},[t("div",{class:"text-xs font-bold text-gray-500"},"参数"),t("hr",{class:"flex-1"})],-1)),t("div",sl,[(n(!0),g(se,null,ne((Fe=(He=G.value)==null?void 0:He.tool)==null?void 0:Fe.inputs,ce=>(n(),g("div",{key:ce.name,class:"flex flex-col gap-2"},[t("div",nl,[t("div",al,T(ce.name),1),t("div",il,T(p(at)[ce.type]),1),ce.required?(n(),g("div",rl,"必填")):Q("",!0)]),t("div",dl,T(ce.description),1)]))),128))])])):Q("",!0)])):Q("",!0),d.value==="setting"?(n(),g("div",ul,[e(et,{model:X.value,"onUpdate:model":c[2]||(c[2]=ce=>X.value=ce),layout:"vertical",class:""},{default:o(()=>{var ce,Qe;return[(n(!0),g(se,null,ne((Qe=(ce=G.value)==null?void 0:ce.tool)==null?void 0:Qe.params,K=>(n(),J(Ze,{key:K.name,field:K.name},{label:o(()=>[t("div",cl,[t("div",pl,T(K.label),1),K.required?(n(),g("div",_l,"*")):Q("",!0),e(xe,{content:K.label},{default:o(()=>[e(me)]),_:2},1032,["content"])])]),default:o(()=>[K.type==="select"?(n(),J(Se,{key:0,"default-value":K.default,"model-value":X.value[K.name],"onUpdate:modelValue":ye=>X.value[K.name]=ye,placeholder:"请输入参数值",options:K.options},null,8,["default-value","model-value","onUpdate:modelValue","options"])):Q("",!0),K.type==="string"?(n(),J(Ve,{key:1,placeholder:"请输入参数值","model-value":X.value[K.name],"onUpdate:modelValue":ye=>X.value[K.name]=ye,"default-value":K.default},null,8,["model-value","onUpdate:modelValue","default-value"])):Q("",!0),K.type==="number"?(n(),J(Xe,{key:2,placeholder:"请输入参数值","model-value":X.value[K.name],"onUpdate:modelValue":ye=>X.value[K.name]=ye,"default-value":K.default,min:K.min,max:K.max},null,8,["model-value","onUpdate:modelValue","default-value","min","max"])):Q("",!0),K.type==="boolean"?(n(),J(Ye,{key:3,"model-value":X.value[K.name],"onUpdate:modelValue":ye=>X.value[K.name]=ye,"default-value":K.default},{default:o(()=>[e(Ue,{value:!0},{default:o(()=>c[10]||(c[10]=[j("开启")])),_:1}),e(Ue,{value:!1},{default:o(()=>c[11]||(c[11]=[j("关闭")])),_:1})]),_:2},1032,["model-value","onUpdate:modelValue","default-value"])):Q("",!0)]),_:2},1032,["field"]))),128))]}),_:1},8,["model"])])):Q("",!0),t("div",gl,[c[14]||(c[14]=t("div",{class:""},null,-1)),e(De,{size:12},{default:o(()=>[e(C,{class:"rounded-lg",onClick:Y},{default:o(()=>c[12]||(c[12]=[j("取消")])),_:1}),e(C,{loading:p(r),type:"primary",class:"rounded-lg",onClick:H},{default:o(()=>c[13]||(c[13]=[j(" 保存 ")])),_:1},8,["loading"])]),_:1})])]}),_:1},8,["visible"]),e(Ae,{visible:ae.value,"onUpdate:visible":c[6]||(c[6]=W=>ae.value=W),"hide-title":"",footer:!1,class:"tools-modal","modal-class":"right-4 h-[calc(100vh-32px)]"},{default:o(()=>[t("div",ml,[t("div",vl,[c[20]||(c[20]=t("div",{class:"text-gray-900 font-bold text-lg mb-4"},"关联插件",-1)),e(tt,{to:{name:"space-tools-list",query:{create_type:"tool"}}},{default:o(()=>[e(C,{long:"",type:"primary",class:"rounded-lg mb-5"},{default:o(()=>c[15]||(c[15]=[j("创建自定义插件")])),_:1})]),_:1}),t("div",fl,[t("div",{class:ie(`rounded-lg h-8 leading-8 px-3 flex items-center gap-2 cursor-pointer hover:bg-white hover:text-blue-700 ${S.value==="api_tool"?"text-blue-700 bg-white":"text-gray-700"}`),onClick:c[3]||(c[3]=W=>S.value="api_tool")},[e(ot),c[16]||(c[16]=j(" 自定义插件 "))],2),t("div",{class:ie(`rounded-lg h-8 leading-8 px-3 flex items-center gap-2 cursor-pointer hover:bg-white hover:text-blue-700 ${S.value==="builtin_tool"?"text-blue-700 bg-white":"text-gray-700"}`),onClick:c[4]||(c[4]=W=>S.value="builtin_tool")},[e(lt),c[17]||(c[17]=j(" 内置插件 "))],2)]),S.value==="builtin_tool"?(n(),g("div",xl,[c[19]||(c[19]=t("div",{class:"text-xs text-gray-500 mb-3"},"类别",-1)),t("div",yl,[t("div",{class:ie(`rounded-lg h-8 leading-8 px-3 flex items-center gap-2 cursor-pointer hover:bg-white hover:text-blue-700 ${u.value==="all"?"text-blue-700 bg-white":"text-gray-700"}`),onClick:c[5]||(c[5]=W=>u.value="all")},[e(st),c[18]||(c[18]=j(" 全部 "))],2),(n(!0),g(se,null,ne(p(M),W=>(n(),g("div",{key:W.name,class:ie(`rounded-lg h-8 leading-8 px-3 flex items-center gap-2 cursor-pointer hover:bg-white hover:text-blue-700 ${u.value===W.category?"text-blue-700 bg-white":" text-gray-700"}`),onClick:pe=>u.value=W.category},[t("span",{innerHTML:W.icon},null,8,hl),j(" "+T(W.name),1)],10,bl))),128))])])):Q("",!0)]),t("div",wl,[t("div",kl,[t("div",$l,T(S.value==="api_tool"?"自定义插件":"内置插件"),1),e(C,{size:"mini",type:"text",class:"!text-gray-700 ml-6"},{icon:o(()=>[e(F)]),_:1})]),S.value==="builtin_tool"?(n(),g("div",Cl,[(n(!0),g(se,null,ne(f.value,(W,pe)=>(n(),g("div",{key:W.name,class:"flex flex-col gap-3 mb-3"},[t("div",ql,T(W.label),1),t("div",Sl,[(n(!0),g(se,null,ne(W.tools,(ue,he)=>(n(),g("div",{key:ue.name,class:ie(`flex items-center justify-between px-2 h-8 rounded-lg cursor-pointer hover:bg-gray-50 group ${oe(W,ue)?"bg-blue-50 border border-blue-700":""}`)},[t("div",zl,[e(D,{size:20,shape:"circle","image-url":`${p(we)}/builtin-tools/${W.name}/icon`},null,8,["image-url"]),t("div",Ul,T(ue.label),1)]),e(C,{size:"mini",class:"hidden group-hover:block rounded px-1.5 flex-shrink-0",onClick:async()=>await ee(pe,he)},{icon:o(()=>[e(z)]),default:o(()=>[j(" "+T(oe(W,ue)?"删除":"添加"),1)]),_:2},1032,["onClick"])],2))),128))])]))),128)),f.value.length===0?(n(),g("div",Dl,[e(Te,{description:"没有可用的内置插件",class:"h-[400px] flex flex-col items-center justify-center"})])):Q("",!0)])):Q("",!0),S.value==="api_tool"?(n(),g("div",Al,[e(je,{loading:p(x),class:"block h-[calc(100vh-130px)] overflow-scroll scrollbar-w-none",onScroll:N},{default:o(()=>[(n(!0),g(se,null,ne(p(P),(W,pe)=>(n(),g("div",{key:W.id,class:"flex flex-col gap-3 mb-3"},[t("div",Tl,T(W.name),1),t("div",jl,[(n(!0),g(se,null,ne(W.tools,(ue,he)=>(n(),g("div",{key:ue.name,class:ie(`flex items-center justify-between px-2 h-8 rounded-lg cursor-pointer hover:bg-gray-50 group ${oe(W,ue)?"bg-blue-50 border border-blue-700":""}`)},[t("div",Ml,[e(D,{size:20,shape:"circle","image-url":W.icon},null,8,["image-url"]),t("div",Il,T(ue.name),1)]),e(C,{size:"mini",class:"hidden group-hover:block rounded px-1.5 flex-shrink-0",onClick:async()=>await ee(Number(pe),he)},{icon:o(()=>[e(z)]),default:o(()=>[j(" "+T(oe(W,ue)?"删除":"添加"),1)]),_:2},1032,["onClick"])],2))),128))])]))),128)),p(P).length===0?(n(),g("div",Bl,[e(Te,{description:"没有可用的API插件",class:"h-[400px] flex flex-col items-center justify-center"})])):Q("",!0),p(L).total_page>=2?(n(),J(nt,{key:1},{default:o(()=>[p(L).current_page<=p(L).total_page?(n(),J(Me,{key:0,span:24,class:"!text-center"},{default:o(()=>[e(De,{class:"my-4"},{default:o(()=>[e(je),c[21]||(c[21]=t("div",{class:"text-gray-400"},"加载中",-1))]),_:1})]),_:1})):(n(),J(Me,{key:1,span:24,class:"!text-center"},{default:o(()=>c[22]||(c[22]=[t("div",{class:"text-gray-400 my-4"},"数据已加载完成",-1)])),_:1}))]),_:1})):Q("",!0)]),_:1},8,["loading"])])):Q("",!0)])])]),_:1},8,["visible"])])}}}),Pl={class:""},Rl={key:0,class:"flex flex-col gap-1"},Wl={class:"flex items-center gap-2"},Gl={class:"flex flex-col flex-1 gap-1 h-9"},Ol={class:"text-gray-700 font-bold leading-[18px] line-clamp-1 break-all"},Hl={class:"text-gray-500 text-xs line-clamp-1 break-all"},Fl={key:1,class:"text-xs text-gray-500 leading-[22px]"},Ql={class:"flex items-center justify-between mb-6"},El={class:"h-[calc(100vh-180px)] mb-4 overflow-scroll scrollbar-w-none"},Nl={class:"flex flex-col gap-2"},Kl=["onClick"],Jl={class:"line-clamp-1 text-gray-500 flex-1"},Vl={class:"flex items-center justify-between"},Xl={class:""},Yl=de({__name:"WorkflowsAbilityItem",props:{app_id:{type:String,default:"",required:!0},workflows:{type:Array,default:()=>[],required:!0}},emits:["update:workflows"],setup(w,{emit:A}){const i=w,k=A,{loading:r,handleUpdateDraftAppConfig:q}=ge(),{loading:a,paginator:y,workflows:m,loadWorkflows:x}=Ut(),L=B(!1),P=B(!1),$=B([]),b=B([]),v=async O=>{const{scrollTop:h,scrollHeight:d,clientHeight:G}=O.target;if(h+G>=d-10){if(a.value)return;await x("","published")}},_=()=>re.isEqual($.value,b.value),M=()=>{L.value=!1,$.value=b.value,P.value=!1},R=O=>{const h=m.value[O];if($.value.some(d=>d.id===h.id))$.value=$.value.filter(d=>d.id!==h.id);else{if($.value.length>=5){_e.warning("关联工作流已超过5个，无法继续关联");return}$.value.push({id:h.id,name:h.name,icon:h.icon,description:h.description})}},V=async()=>{await q(i.app_id,{workflows:$.value.map(O=>O.id)}),b.value=$.value,await ke(),k("update:workflows",$.value),M()};return ve(()=>i.workflows,O=>{if((!P.value||!_())&&O&&O.length>0){const h=i.workflows.map(d=>({id:d.id,name:d.name,icon:d.icon,description:d.description}));$.value=re.cloneDeep(h),b.value=re.cloneDeep(h),P.value=!0}},{immediate:!0,deep:!0}),ve(()=>L.value,async O=>{O?await x("","published",!0):m.value.splice(0,m.value.length)}),(O,h)=>{const d=l("icon-plus"),G=l("a-button"),te=l("a-avatar"),X=l("icon-delete"),ae=l("a-collapse-item"),S=l("icon-close"),u=l("a-empty"),f=l("a-spin"),E=l("a-space"),Y=l("a-col"),H=l("a-row"),Z=l("a-modal");return n(),g("div",Pl,[e(ae,{key:"workflows",class:"app-ability-item"},{header:o(()=>h[1]||(h[1]=[t("div",{class:"text-gray-700 font-bold"},"工作流",-1)])),extra:o(()=>[e(G,{size:"mini",type:"text",class:"!text-gray-700",onClick:h[0]||(h[0]=be(U=>L.value=!0,["stop"]))},{icon:o(()=>[e(d)]),_:1})]),default:o(()=>{var U;return[((U=i.workflows)==null?void 0:U.length)>0?(n(),g("div",Rl,[(n(!0),g(se,null,ne(i.workflows,(N,ee)=>(n(),g("div",{key:N.id,class:"flex items-center justify-between bg-white p-3 rounded-lg cursor-pointer hover:shadow-sm group"},[t("div",Wl,[e(te,{size:36,shape:"square",class:"rounded flex-shrink-0","image-url":N.icon},null,8,["image-url"]),t("div",Gl,[t("div",Ol,T(N.name),1),t("div",Hl,T(N.description),1)])]),e(G,{size:"mini",type:"text",class:"hidden group-hover:block flex-shrink-0 ml-2 !text-red-700 rounded",onClick:async()=>{const oe=[...i.workflows];oe.splice(ee,1),await p(q)(i.app_id,{workflows:oe.map(s=>s.id)}),P.value=!1,k("update:workflows",oe)}},{icon:o(()=>[e(X)]),_:2},1032,["onClick"])]))),128))])):(n(),g("div",Fl," 工作流支持通过可视化的方式，对插件、大语言模型、代码块等功能进行组合，从而实现复杂、稳定的业务流程编排，例如旅行规划、报告分析等。 "))]}),_:1}),e(Z,{visible:L.value,"hide-title":"",footer:!1,width:400,class:"workflows-modal","modal-class":"h-[calc(100vh-32px)] right-4",onCancel:M},{default:o(()=>[t("div",Ql,[h[2]||(h[2]=t("div",{class:"text-lg font-bold text-gray-700"},"选择关联工作流",-1)),e(G,{type:"text",class:"!text-gray-700",size:"small",onClick:M},{icon:o(()=>[e(S)]),_:1})]),t("div",El,[e(f,{loading:p(a),class:"block h-full w-full scrollbar-w-none overflow-scroll",onScroll:v},{default:o(()=>[t("div",Nl,[(n(!0),g(se,null,ne(p(m),(U,N)=>(n(),g("div",{key:U.id,class:ie(`flex items-center gap-2 border px-3 py-2 rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-700 ${$.value.some(ee=>ee.id===U.id)?"bg-blue-50 border-blue-700":""}`),onClick:()=>R(N)},[e(te,{size:24,shape:"square",class:"flex-shrink-0 rounded","image-url":U.icon},null,8,["image-url"]),t("div",Jl,T(U.name),1)],10,Kl))),128)),p(m).length===0?(n(),J(u,{key:0,description:"没有可用的工作流",class:"h-[400px] flex flex-col items-center justify-center"})):Q("",!0)]),p(y).total_page>=2?(n(),J(H,{key:0},{default:o(()=>[p(y).current_page<=p(y).total_page?(n(),J(Y,{key:0,span:24,class:"!text-center"},{default:o(()=>[e(E,{class:"my-4"},{default:o(()=>[e(f),h[3]||(h[3]=t("div",{class:"text-gray-400"},"加载中",-1))]),_:1})]),_:1})):(n(),J(Y,{key:1,span:24,class:"!text-center"},{default:o(()=>h[4]||(h[4]=[t("div",{class:"text-gray-400 my-4"},"数据已加载完成",-1)])),_:1}))]),_:1})):Q("",!0)]),_:1},8,["loading"])]),t("div",Vl,[t("div",Xl,T($.value.length)+" 个工作流被选中",1),e(E,{size:12},{default:o(()=>[e(G,{class:"rounded-lg",onClick:M},{default:o(()=>h[5]||(h[5]=[j("取消")])),_:1}),e(G,{loading:p(r),type:"primary",class:"rounded-lg",onClick:V},{default:o(()=>h[6]||(h[6]=[j(" 添加 ")])),_:1},8,["loading"])]),_:1})])]),_:1},8,["visible"])])}}}),Zl={class:"flex flex-col h-[calc(100vh-141px)]"},es={class:"flex-1 overflow-scroll scrollbar-w-none"},ts=de({__name:"AgentAppAbility",props:{app_id:{type:String,default:"",required:!0},draft_app_config:{type:Object,required:!0}},emits:["update:draft_app_config"],setup(w,{emit:A}){const i=["tools","workflows","datasets","long_term_memory","opening","suggested_after_answer","review_config"];return(k,r)=>{const q=l("icon-down"),a=l("icon-right"),y=l("a-collapse");return n(),g("div",Zl,[r[8]||(r[8]=t("div",{class:"p-4 text-gray-700 font-bold"},"应用能力",-1)),t("div",es,[e(y,{bordered:!1,"default-active-key":i},{"expand-icon":o(({active:m})=>[m?(n(),J(q,{key:0})):(n(),J(a,{key:1}))]),default:o(()=>[e(Ll,{tools:w.draft_app_config.tools,"onUpdate:tools":r[0]||(r[0]=m=>w.draft_app_config.tools=m),app_id:w.app_id},null,8,["tools","app_id"]),e(Yl,{workflows:w.draft_app_config.workflows,"onUpdate:workflows":r[1]||(r[1]=m=>w.draft_app_config.workflows=m),app_id:w.app_id},null,8,["workflows","app_id"]),e(Wo,{retrieval_config:w.draft_app_config.retrieval_config,"onUpdate:retrieval_config":r[2]||(r[2]=m=>w.draft_app_config.retrieval_config=m),datasets:w.draft_app_config.datasets,"onUpdate:datasets":r[3]||(r[3]=m=>w.draft_app_config.datasets=m),app_id:w.app_id},null,8,["retrieval_config","datasets","app_id"]),e(Kt,{long_term_memory:w.draft_app_config.long_term_memory,"onUpdate:long_term_memory":r[4]||(r[4]=m=>w.draft_app_config.long_term_memory=m),app_id:w.app_id},null,8,["long_term_memory","app_id"]),e(oo,{opening_questions:w.draft_app_config.opening_questions,"onUpdate:opening_questions":r[5]||(r[5]=m=>w.draft_app_config.opening_questions=m),opening_statement:w.draft_app_config.opening_statement,"onUpdate:opening_statement":r[6]||(r[6]=m=>w.draft_app_config.opening_statement=m),app_id:w.app_id},null,8,["opening_questions","opening_statement","app_id"]),e(so,{suggested_after_answer:w.draft_app_config.suggested_after_answer,"onUpdate:suggested_after_answer":r[7]||(r[7]=m=>w.draft_app_config.suggested_after_answer=m),app_id:w.app_id},null,8,["suggested_after_answer","app_id"]),e(xo,{review_config:w.draft_app_config.review_config,app_id:w.app_id},null,8,["review_config","app_id"])]),_:1})])])}}}),os={class:""},ls={class:"flex flex-col gap-6 py-6"},ss={key:0,class:"h-[50px] flex items-center justify-center"},ns={class:"flex flex-col items-center gap-2"},as={class:"text-lg text-gray-700"},is={key:0,class:"bg-gray-100 w-full px-4 py-3 rounded-lg text-gray-700"},rs={class:"flex items-center flex-wrap gap-2 w-full"},ds=["onClick"],us={class:"w-full flex flex-col flex-shrink-0"},cs={class:"px-6 flex items-center gap-4"},ps={key:0,class:"flex items-center gap-2"},_s={class:"hidden group-hover:flex items-center justify-center bg-gray-700/50 w-10 h-10 absolute top-0"},gs={class:"flex items-center gap-2"},ms=de({__name:"PreviewDebugChat",props:{app:{type:Object,default:()=>({}),required:!0},suggested_after_answer:{type:Object,default:()=>({enable:!0}),required:!0},opening_statement:{type:String,default:"",required:!0},opening_questions:{type:Array,default:()=>[],required:!0}},setup(w){const A=Je(),i=w,k=B(""),r=B([]),q=B(null),a=B(!1),y=B(""),m=B(""),x=B(null),L=B(0),P=it(),{loading:$,handleDeleteDebugConversation:b}=pt(),{loading:v,messages:_,loadDebugConversationMessages:M}=_t(),{loading:R,handleDebugChat:V}=gt(),{loading:O,handleStopDebugChat:h}=mt(),{suggested_questions:d,handleGenerateSuggestedQuestions:G}=xt(),te=()=>{L.value=x.value.$el.scrollHeight},X=()=>{x.value.$el.scrollTop=x.value.$el.scrollHeight-L.value},ae=async H=>{var U;const{scrollTop:Z}=H.target;Z<=0&&!v.value&&(te(),await M(String((U=A.params)==null?void 0:U.app_id),!1),X())},S=async()=>{var N;if(k.value.trim()===""){_e.warning("用户提问不能为空");return}if(R.value){_e.warning("上一次提问还未结束，请稍等");return}d.value=[],y.value="",m.value="",_.value.unshift({id:"",conversation_id:"",query:k.value,image_urls:r.value,answer:"",total_token_count:0,latency:0,agent_thoughts:[],created_at:0});let H=0;const Z=k.value,U=r.value;k.value="",r.value=[],await V((N=i.app)==null?void 0:N.id,Z,U,ee=>{var C;const oe=ee==null?void 0:ee.event,s=ee==null?void 0:ee.data,c=s==null?void 0:s.id,z=_.value[0].agent_thoughts;if(y.value===""&&(s!=null&&s.message_id)&&(m.value=s==null?void 0:s.task_id,y.value=s==null?void 0:s.message_id,_.value[0].id=s==null?void 0:s.message_id,_.value[0].conversation_id=s==null?void 0:s.conversation_id),oe!==$e.ping){if(oe===$e.agentMessage){const D=z.findIndex(I=>(I==null?void 0:I.id)===c);D===-1?(H+=1,z.push({id:c,position:H,event:s==null?void 0:s.event,thought:s==null?void 0:s.thought,observation:s==null?void 0:s.observation,tool:s==null?void 0:s.tool,tool_input:s==null?void 0:s.tool_input,latency:s==null?void 0:s.latency,created_at:0})):z[D]={...z[D],thought:((C=z[D])==null?void 0:C.thought)+(s==null?void 0:s.thought),latency:s==null?void 0:s.latency},_.value[0].answer+=s==null?void 0:s.thought,_.value[0].latency=s==null?void 0:s.latency,_.value[0].total_token_count=s==null?void 0:s.total_token_count}else oe===$e.error?_.value[0].answer=s==null?void 0:s.observation:oe===$e.timeout?_.value[0].answer="当前Agent执行已超时，无法得到答案，请重试":(H+=1,z.push({id:c,position:H,event:s==null?void 0:s.event,thought:s==null?void 0:s.thought,observation:s==null?void 0:s.observation,tool:s==null?void 0:s.tool,tool_input:s==null?void 0:s.tool_input,latency:s==null?void 0:s.latency,created_at:0}));_.value[0].agent_thoughts=z,x.value.scrollToBottom()}}),i.suggested_after_answer.enable&&y.value&&(G(y.value),setTimeout(()=>x.value&&x.value.scrollToBottom(),100))},u=async()=>{var H;m.value===""||!R.value||await h((H=i.app)==null?void 0:H.id,m.value)},f=async H=>{k.value=H,await S()},E=()=>{if(r.value.length>=5){_e.error("对话上传图片数量不能超过5张");return}q.value.click()},Y=async H=>{var N;if(a.value)return;const U=(N=H.target.files)==null?void 0:N[0];if(U)try{a.value=!0;const ee=await dt(U);r.value.push(ee.data.image_url),_e.success("上传图片成功")}finally{a.value=!1}};return Ce(async()=>{var H;await M(String((H=A.params)==null?void 0:H.app_id),!0),await ke(()=>{x.value&&x.value.scrollToBottom()})}),(H,Z)=>{var C,D;const U=l("icon-poweroff"),N=l("a-button"),ee=l("a-avatar"),oe=l("icon-empty"),s=l("icon-close"),c=l("icon-plus"),z=l("icon-send");return n(),g("div",os,[p(_).length>0?(n(),g("div",{key:0,class:ie(`flex flex-col px-6 ${r.value.length>0?"h-[calc(100vh-288px)]":"h-[calc(100vh-238px)]"}`)},[e(p(wt),{ref_key:"scroller",ref:x,items:p(_).slice().reverse(),"min-item-size":1,onScroll:ae,class:"h-full scrollbar-w-none"},{default:o(({item:I,active:le})=>[e(p(yt),{item:I,active:le,"data-index":I.id},{default:o(()=>[t("div",ls,[e(bt,{query:I.query,image_urls:I.image_urls,account:p(P).account},null,8,["query","image_urls","account"]),e(ht,{message_id:I.id,agent_thoughts:I.agent_thoughts,answer:I.answer,app:i.app,suggested_questions:I.id===y.value?p(d):[],loading:I.id===y.value&&p(R),latency:I.latency,total_token_count:I.total_token_count,onSelectSuggestedQuestion:f,message_class:"max-w-[calc(100%-65px)]"},null,8,["message_id","agent_thoughts","answer","app","suggested_questions","loading","latency","total_token_count"])])]),_:2},1032,["item","active","data-index"])]),_:1},8,["items"]),m.value&&p(R)?(n(),g("div",ss,[e(N,{loading:p(O),class:"rounded-lg px-2",onClick:u},{icon:o(()=>[e(U)]),default:o(()=>[Z[2]||(Z[2]=j(" 停止响应 "))]),_:1},8,["loading"])])):Q("",!0)],2)):(n(),g("div",{key:1,class:ie(`flex flex-col p-6 gap-2 items-center justify-center ${r.value.length>0?"h-[calc(100vh-288px)]":"h-[calc(100vh-238px)]"}`)},[t("div",ns,[e(ee,{size:48,shape:"square",class:"rounded-lg","image-url":(C=i.app)==null?void 0:C.icon},null,8,["image-url"]),t("div",as,T((D=i.app)==null?void 0:D.name),1)]),i.opening_statement?(n(),g("div",is,T(i.opening_statement),1)):Q("",!0),t("div",rs,[(n(!0),g(se,null,ne(i.opening_questions.filter(I=>I.trim()!==""),(I,le)=>(n(),g("div",{key:le,class:"px-4 py-1.5 border rounded-lg text-gray-700 cursor-pointer hover:bg-gray-50",onClick:async()=>await f(I)},T(I),9,ds))),128))])],2)),t("div",us,[t("div",cs,[e(N,{loading:p($),class:"flex-shrink-0 !text-gray-700",type:"text",shape:"circle",onClick:Z[0]||(Z[0]=async()=>{var I,le;await u(),await p(b)((I=i.app)==null?void 0:I.id),await p(M)((le=i.app)==null?void 0:le.id,!0)})},{icon:o(()=>[e(oe,{size:16})]),_:1},8,["loading"]),t("div",{class:ie(`${r.value.length>0?"h-[100px]":"h-[50px]"} flex flex-col justify-center gap-2 px-4 flex-1 border border-gray-200 rounded-[24px]`)},[r.value.length>0?(n(),g("div",ps,[(n(!0),g(se,null,ne(r.value,(I,le)=>(n(),g("div",{key:I,class:"w-10 h-10 relative rounded-lg overflow-hidden group cursor-pointer"},[e(ee,{shape:"square","image-url":I},null,8,["image-url"]),t("div",_s,[e(s,{class:"text-white",onClick:()=>r.value.splice(le,1)},null,8,["onClick"])])]))),128))])):Q("",!0),t("div",gs,[Ee(t("input",{"onUpdate:modelValue":Z[1]||(Z[1]=I=>k.value=I),type:"text",class:"flex-1 outline-0",onKeyup:rt(S,["enter"])},null,544),[[Ne,k.value]]),t("input",{type:"file",ref_key:"fileInput",ref:q,accept:"image/*",onChange:Y,class:"hidden"},null,544),e(N,{loading:a.value,size:"mini",type:"text",shape:"circle",class:"!text-gray-700",onClick:E},{icon:o(()=>[e(c)]),_:1},8,["loading"]),e(N,{loading:p(R),type:"text",shape:"circle",class:"!text-gray-700",onClick:S},{icon:o(()=>[e(z,{size:16})]),_:1},8,["loading"])])],2)]),Z[3]||(Z[3]=t("div",{class:"text-center text-gray-500 text-xs py-4"}," 内容由AI生成，无法确保真实准确，仅供参考。 ",-1))])])}}}),vs={class:"flex items-center gap-1 cursor-pointer hover:bg-gray-100 px-1.5 py-1 rounded-lg"},fs={class:"text-gray-700 text-xs"},xs={class:"bg-white px-6 py-5 shadow rounded-lg w-[460px]"},ys={class:"flex flex-col gap-2 mb-2"},bs={class:"flex items-center gap-2"},hs={class:"text-xs text-gray-700"},ws={class:"text-xs text-gray-700"},ks={class:"flex items-center gap-2"},$s={class:"text-xs text-gray-700 py-2"},Cs={class:"flex items-center gap-2 text-gray-500 w-[120px] flex-shrink-0"},qs={class:"text-xs"},Ss={class:"flex items-center gap-2 h-8"},zs={class:"flex items-center gap-2 text-gray-500 w-[120px] flex-shrink-0"},Us=de({__name:"ModelConfig",props:{app_id:{type:String,default:"",required:!0},model_config:{type:Object,default:()=>({}),required:!0},dialog_round:{type:Number,default:3,required:!0}},emits:["update:model_config"],setup(w,{emit:A}){const i=w,k=A,r=B({}),{loading:q,language_model:a,loadLanguageModel:y}=Dt(),{language_models:m,loadLanguageModels:x}=At(),{handleUpdateDraftAppConfig:L}=ge(),P=ze(()=>m.value.map(v=>({isGroup:!0,label:v.label,options:v.models.map(_=>({label:_.label,value:`${v.name}/${_.model_name}`}))}))),$=v=>{const[_,M]=v.split("/");y(_,M).then(()=>{r.value.parameters=a.value.parameters.reduce((R,V)=>(R[V.name]=V.default??null,R),{})})},b=()=>{const[v,_]=r.value.selectValue.split("/"),M={provider:v,model:_,parameters:r.value.parameters};L(i.app_id,{model_config:M,dialog_round:r.value.dialog_round}).then(()=>k("update:model_config",M))};return ve(()=>i.model_config,v=>{r.value.selectValue=`${v==null?void 0:v.provider}/${v.model}`,r.value.provider=v==null?void 0:v.provider,r.value.model=v==null?void 0:v.model,r.value.parameters=v==null?void 0:v.parameters,v!=null&&v.provider&&y(v==null?void 0:v.provider,v==null?void 0:v.model)},{immediate:!0}),ve(()=>i.dialog_round,v=>{r.value.dialog_round=v},{immediate:!0}),Ce(()=>{x()}),(v,_)=>{var S;const M=l("a-avatar"),R=l("icon-down"),V=l("a-space"),O=l("a-select"),h=l("icon-question-circle"),d=l("a-tooltip"),G=l("a-slider"),te=l("a-input"),X=l("a-spin"),ae=l("a-trigger");return(S=i.model_config)!=null&&S.provider?(n(),J(ae,{key:0,trigger:"click",position:"bl","popup-translate":[0,12],onHide:b},{content:o(()=>[t("div",xs,[_[5]||(_[5]=t("div",{class:"text-gray-700 text-base font-semibold mb-3"},"模型设置",-1)),t("div",ys,[_[3]||(_[3]=t("div",{class:"text-gray-700"},"模型",-1)),e(O,{"model-value":r.value.selectValue,"onUpdate:modelValue":_[0]||(_[0]=u=>r.value.selectValue=u),options:P.value,size:"small",class:"rounded-lg mb-2",placeholder:"请选择Agent使用的大语言模型",onChange:$},{label:o(({data:u})=>[t("div",bs,[e(M,{size:16,shape:"square","image-url":`${p(we)}/language-models/${u.value.split("/")[0]}/icon`},null,8,["image-url"]),e(V,{size:4},{default:o(()=>[t("div",hs,T(u.value.split("/")[0]),1),_[2]||(_[2]=t("div",{class:"text-xs text-gray-500"},"·",-1)),t("div",ws,T(u.value.split("/")[1]),1)]),_:2},1024)])]),option:o(({data:u})=>[t("div",ks,[e(M,{size:16,shape:"square","image-url":`${p(we)}/language-models/${u.value.split("/")[0]}/icon`},null,8,["image-url"]),t("div",$s,T(u.label),1)])]),_:1},8,["model-value","options"])]),_[6]||(_[6]=t("div",{class:"text-gray-700 mb-2"},"参数",-1)),e(X,{loading:p(q),class:"w-full"},{default:o(()=>{var u;return[(n(!0),g(se,null,ne((u=p(a))==null?void 0:u.parameters,f=>{var E;return n(),g("div",{key:f.name,class:"flex items-center gap-2 h-8 mb-4"},[t("div",Cs,[t("div",qs,T(f==null?void 0:f.label),1),e(d,{content:f==null?void 0:f.help},{default:o(()=>[e(h)]),_:2},1032,["content"])]),((E=f==null?void 0:f.options)==null?void 0:E.length)>0?(n(),J(O,{key:0,"model-value":r.value.parameters[f.name],"onUpdate:modelValue":Y=>r.value.parameters[f.name]=Y,"default-value":f.default,placeholder:"请选择参数值",options:f.options},null,8,["model-value","onUpdate:modelValue","default-value","options"])):f.type==="boolean"?(n(),J(O,{key:1,"model-value":r.value.parameters[f.name],"onUpdate:modelValue":Y=>r.value.parameters[f.name]=Y,"default-value":f.default,placeholder:"请选择参数值",options:[{label:"是",value:!0},{label:"否",value:!1}]},null,8,["model-value","onUpdate:modelValue","default-value"])):["int","float"].includes(f.type)?(n(),J(G,{key:2,"model-value":r.value.parameters[f.name],"onUpdate:modelValue":Y=>r.value.parameters[f.name]=Y,"default-value":f.default,min:f==null?void 0:f.min,max:f==null?void 0:f.max,step:(f==null?void 0:f.type)==="float"?.1:1,"show-input":""},null,8,["model-value","onUpdate:modelValue","default-value","min","max","step"])):f.type==="string"?(n(),J(te,{key:3,"model-value":r.value.parameters[f.name],"onUpdate:modelValue":Y=>r.value.parameters[f.name]=Y,"default-value":f.default,placeholder:"请输入参数值"},null,8,["model-value","onUpdate:modelValue","default-value"])):Q("",!0)])}),128))]}),_:1},8,["loading"]),_[7]||(_[7]=t("div",{class:"text-gray-700 mb-2"},"输入及输出设置",-1)),t("div",Ss,[t("div",zs,[_[4]||(_[4]=t("div",{class:"text-xs"},"携带上下文轮数",-1)),e(d,{content:"每次向Agent提问时需要携带的最近消息对话轮数，默认为3。"},{default:o(()=>[e(h)]),_:1})]),e(G,{"model-value":r.value.dialog_round,"onUpdate:modelValue":_[1]||(_[1]=u=>r.value.dialog_round=u),"default-value":3,"show-input":"",min:0,max:10,step:1},null,8,["model-value"])])])]),default:o(()=>{var u,f;return[t("div",vs,[e(M,{size:16,shape:"square","image-url":`${p(we)}/language-models/${(u=r.value)==null?void 0:u.provider}/icon`},null,8,["image-url"]),t("div",fs,T((f=r.value)==null?void 0:f.model),1),e(R)])]}),_:1})):Q("",!0)}}}),Ds={class:"flex-1 w-full min-h-0 bg-white"},As={class:"flex-1 grid grid-cols-[26fr_14fr] h-full w-full"},Ts={class:"bg-gray-50 flex flex-col h-full"},js={class:"flex items-center h-16 border-b p-4 gap-4"},Ms={class:"grid grid-cols-[13fr_13fr] overflow-hidden h-[calc(100vh-141px)]"},Is={class:"border-r py-4"},Bs={class:"min-w-[404px]"},Es=de({__name:"DetailView",props:{app:{type:Object,default:()=>({}),required:!0}},setup(w){const A=Je(),i=w,{draftAppConfigForm:k,loadDraftAppConfig:r}=vt();return Ce(async()=>{var q;await r(String((q=A.params)==null?void 0:q.app_id))}),(q,a)=>{var y,m,x,L,P;return n(),g("div",Ds,[t("div",As,[t("div",Ts,[t("div",js,[a[3]||(a[3]=t("div",{class:"text-lg text-gray-700"},"应用编排",-1)),e(Us,{dialog_round:p(k).dialog_round,model_config:p(k).model_config,"onUpdate:model_config":a[0]||(a[0]=$=>p(k).model_config=$),app_id:String((y=p(A).params)==null?void 0:y.app_id)},null,8,["dialog_round","model_config","app_id"])]),t("div",Ms,[t("div",Is,[e(Wt,{preset_prompt:p(k).preset_prompt,"onUpdate:preset_prompt":a[1]||(a[1]=$=>p(k).preset_prompt=$),app_id:String((m=p(A).params)==null?void 0:m.app_id)},null,8,["preset_prompt","app_id"])]),e(ts,{draft_app_config:p(k),"onUpdate:draft_app_config":a[2]||(a[2]=$=>Ke(k)?k.value=$:null),app_id:String((x=p(A).params)==null?void 0:x.app_id)},null,8,["draft_app_config","app_id"])])]),t("div",Bs,[e(Et,{app_id:String((L=p(A).params)==null?void 0:L.app_id),long_term_memory:p(k).long_term_memory},null,8,["app_id","long_term_memory"]),e(ms,{suggested_after_answer:p(k).suggested_after_answer,opening_questions:p(k).opening_questions,opening_statement:p(k).opening_statement,app:i.app,app_id:(P=i.app)==null?void 0:P.id},null,8,["suggested_after_answer","opening_questions","opening_statement","app","app_id"])])])])}}});export{Es as default};
